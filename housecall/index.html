<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>House Call</title>
  <meta name="description" content="2d video game">
  <script src="./assets/phaser3.6.0.min.js"></script>
  <link rel="shortcut icon" type="image" href="./assets/cultknifelogo.png">
  <style type="text/css">
    body {
      margin: 0;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background-color: black;
      overflow: hidden;
    }
  </style>
</head>
<body>
    <script type="text/javascript" src="./player.js"></script>
    <script type="text/javascript" src="./cult.js"></script>
    <script type="text/javascript" src="./cultKnife.js"></script>
    <script type="text/javascript" src="./eye.js"></script>
    <script type="text/javascript">
        class pipeNext extends Phaser.Physics.Arcade.Sprite
        {
            constructor(scene, x, y, key, fromLevel, gameManager) 
            {
                super(scene, x, y, 'pipe');

                this.pipe = scene.physics.add.sprite(x, y, 'pipe');
                this.pipe.setOrigin(0, 1);
                this.pipe.body.allowGravity = false;
                this.pipe.body.setImmovable(true);

                if(!scene.anims.get('stabAnim'))
                {
                    scene.anims.create
                    ({
                        key: "stabAnim",
                        frames: this.anims.generateFrameNumbers('stab', {start: 0, end: 2 }),
                        frameRate: 2,
                        repeat: 0
                    });
                }
                scene.stab = scene.add.sprite(this.pipe.x + 1, this.pipe.y, "stab").setOrigin(0, 1);
                scene.stab.setActive(false);
                scene.stab.setVisible(false);

                scene.physics.add.collider(this.pipe, scene.player, (pipe, player) =>
                {
                    player.destroy();
                    scene.stab.setActive(true);
                    scene.stab.setVisible(true);
                    scene.sound.play('powerup');

                    scene.stab.on(Phaser.Animations.Events.ANIMATION_UPDATE, (anim, frame) => 
                    {
                        if(frame.index === 2) 
                        {
                            let aCultActive = false;
                            scene.sound.play('stab');

                            if(scene.cults && scene.cults.children.entries)
                            {
                                const cultsArray = scene.cults.children.entries; 

                                for(let i = cultsArray.length - 1; i >= 0; i--) 
                                {
                                    const cult = cultsArray[i];
                                    aCultActive = true;
                                    cult.kill();  
                                }
                            }

                            if(scene.cultKnifes && scene.cultKnifes.children.entries)
                            {
                                const cultKnifesArray = scene.cultKnifes.children.entries; 

                                for(let i = cultKnifesArray.length - 1; i >= 0; i--) 
                                {
                                    const cultKnife = cultKnifesArray[i];
                                    aCultActive = true;
                                    cultKnife.kill();  
                                }
                            }

                            if(scene.eyes && scene.eyes.children.entries)
                            {
                                const eyesArray = scene.eyes.children.entries; 

                                for(let i = eyesArray.length - 1; i >= 0; i--) 
                                {
                                    const eye = eyesArray[i];
                                    aCultActive = true;
                                    eye.kill();  
                                }
                            }

                            if(aCultActive)
                            {
                                scene.sound.play('hurt');
                            }
                        }
                    });
                    scene.stab.play("stabAnim", true);
                });

                scene.stab.on(Phaser.Animations.Events.ANIMATION_COMPLETE, () => 
                {
                    transitionLevels(scene, gameManager);
                });
            }
        }
  
        function transitionLevels(scene, gameManager)
        {
            if(gameManager.currentLevel === 1)
            {
                if(gameManager.visitedUpgradeRoom1 === true)
                {
                    scene.scene.start('Level2Game');
                    scene.scene.launch('HUD');
                }
                else
                {
                    gameManager.visitedUpgradeRoom1 = true;
                    scene.scene.start('UpgradeRoom');
                    scene.scene.stop('HUD');
                }
            }
            else if(gameManager.currentLevel === 2)
            {
                if(gameManager.visitedUpgradeRoom2 === true)
                {
                    scene.scene.start('Level3Game');
                    scene.scene.launch('HUD');
                }
                else
                {
                    gameManager.visitedUpgradeRoom2 = true;
                    scene.scene.start('UpgradeRoom');
                    scene.scene.stop('HUD');
                }
            }
            else if(gameManager.currentLevel === 3)
            {
                if(gameManager.visitedUpgradeRoom3 === true)
                {
                    scene.scene.start('Level4Game');
                    scene.scene.launch('HUD');
                }
                else
                {
                    gameManager.visitedUpgradeRoom3 = true;
                    scene.scene.start('UpgradeRoom');
                    scene.scene.stop('HUD');
                }
            }
            else if(gameManager.currentLevel === 4)
            {
                scene.scene.stop('HUD');
                scene.gameManager.reset();
                scene.scene.start('Level1Game');
                scene.scene.launch('HUD');
            }
        }

        class Loading extends Phaser.Scene
        {
            constructor()
            {
              super({key: 'Loading'});
            }

            preload()
            {
                this.load.image('sky', 'assets/sky.png');
                this.load.spritesheet('player', 'assets/player.png', {frameWidth: 16, frameHeight: 16});
                this.load.image('ground', 'assets/grass.png');
                this.load.image('bullet', 'assets/bullet.png');
                this.load.image('barn', 'assets/barn.png');
                this.load.image('fence', 'assets/fence.png');
                this.load.image('stars', 'assets/stars.png');
                this.load.image('cross', 'assets/cross.png');
                this.load.spritesheet('cult', './assets/cult.png', {frameWidth: 16, frameHeight: 16});
                this.load.image('couch', './assets/couch.png');
                this.load.image('tractor', './assets/tractor.png');
                this.load.spritesheet('grasstop', './assets/grasstop.png', {frameWidth: 32, frameHeight: 16});
                this.load.image('grill', './assets/grill.png');
                this.load.spritesheet('cultknife', './assets/cultknife.png', {frameWidth: 16, frameHeight: 16});
                this.load.image('copcar', './assets/copcar.png');
                this.load.image('cultorb', './assets/cultorb.png');
                this.load.spritesheet('wheat', './assets/wheat.png', {frameWidth: 16, frameHeight: 16});
                this.load.image('shed', './assets/shed.png');
                this.load.image('silo', './assets/silo.png');
                this.load.image('scarecrow', './assets/scarecrow.png');
                this.load.image('pipe', './assets/pipe.png');
                this.load.image('eye', './assets/eye.png');
                this.load.spritesheet('stab', './assets/stab.png', {frameWidth: 12, frameHeight: 18});
                this.load.image('blood', 'assets/bloodparticle.png');
                this.load.image('eyechunk', 'assets/eyechunk.png');
                this.load.image('shell', 'assets/shell.png');
                this.load.image('raindrop', 'assets/raindrop.png');
                this.load.image('bloodrain', 'assets/bloodrain.png');
                this.load.image('redsky', 'assets/redsky.png');
                this.load.image('redskyrain', 'assets/redskyrain.png');
                this.load.image('bulletcult', 'assets/bulletcult.png');
                this.load.image('slug', 'assets/slug.png');
                this.load.image('slugcult', 'assets/slugcult.png');
                this.load.image('slugshell', 'assets/slugshell.png');
                this.load.image('slugicon', 'assets/slugicon.png');
                this.load.image('birdshotshell', 'assets/birdshotshell.png');
                this.load.image('birdshoticon', 'assets/birdshoticon.png');
                this.load.image('healthicon', 'assets/healthicon.png');
                this.load.image('shieldicon', 'assets/shieldicon.png');
                this.load.image('damageicon', 'assets/damageicon.png');
                this.load.image('cultenergyicon', 'assets/cultenergyicon.png');
                this.load.image('hollowpointsicon', 'assets/hollowpointsicon.png');
                this.load.image('pistolcasing', 'assets/pistolcasing.png');
                this.load.image('multiammoicon', 'assets/multiammoicon.png');
                this.load.image('triplepistolicon', 'assets/triplepistolicon.png');
                this.load.image('quintuplepistolicon', 'assets/quintuplepistolicon.png');
                this.load.image('mousepistolicon', 'assets/mousepistolicon.png');
                this.load.image('numfourbuckshotshell', 'assets/numfourbuckshotshell.png');
                this.load.image('numfourbuckshoticon', 'assets/numfourbuckshoticon.png');
                this.load.image('000buckshoticon', 'assets/000buckshoticon.png');

                this.load.audio('shotgunshot', 
                [
                    'assets/shotgunshot.wav'
                ]);

                this.load.audio('slug', 
                [
                    'assets/slug.wav'
                ]);

                this.load.audio('orbthrow', 
                [
                    'assets/orbthrow.wav'
                ]);

                this.load.audio('hurt', 
                [
                    'assets/hurt.wav'
                ]);

                this.load.audio('powerup', 
                [
                    'assets/powerup.wav'
                ]);

                this.load.audio('block', 
                [
                    'assets/block.wav'
                ]);

                this.load.audio('stab', 
                [
                    'assets/stab.wav'
                ]);

                this.load.audio('eyeorb', 
                [
                    'assets/eyeorb.wav'
                ]);

                this.load.audio('birdshot', 
                [
                    'assets/birdshot.wav'
                ]);

                this.load.audio('switchfiremode', 
                [
                    'assets/switchfiremode.wav'
                ]);

                this.load.audio('pistolsound', 
                [
                    'assets/pistolsound.wav'
                ]);
                
                this.load.audio('000buckshot', 
                [
                    'assets/000buckshot.wav'
                ]);
                
                this.load.audio('numfourbuckshot', 
                [
                    'assets/numfourbuckshot.wav'
                ]);
            }

            create()
            {
                this.loading = this.add.text((this.sys.game.config.width / 2), this.sys.game.config.height / 2, 'Loading', { fontSize: '16px', fill: '#fff' }).setOrigin(0.5);
            }

            update()
            {
                this.scene.stop('Loading');
                this.scene.start('GameManager');
                this.scene.start('MainMenu');
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
        
        class Wheat
        {
            constructor(scene, worldWidthX)
            {
                this.frameCounter = 0;
                this.frameRate = 48;       
                this.maxFrames = 2;        
                this.width = worldWidthX;
                this.scene = scene;
                this.direction = 1;
                this.currentFrameIndex = 0;
                this.create();
                this.scene.events.on('update', this.update, this);
                this.scene.events.once('shutdown', () => 
                {
                    this.scene.events.off('update', this.update, this);
                });
            }

            create() 
            {
                this.scene.wheat = this.scene.add.tileSprite(0, this.scene.sys.game.config.height - 16, this.width, 16, 'wheat', this.currentFrameIndex).setOrigin(0, 1).setScrollFactor(0.575);
            }

            update(time, delta) 
            {
                this.frameCounter += 1;

                if(this.frameCounter % this.frameRate === 0) 
                {
                    let currentFrame = this.currentFrameIndex;

                    if(currentFrame === this.maxFrames - 1 && this.direction === 1) 
                    { 
                        this.direction = -1; 
                    } 
                    else if (currentFrame === 0 && this.direction === -1) 
                    {
                        this.direction = 1;  
                    }

                    let nextFrameIndex = currentFrame + this.direction;

                    this.scene.wheat.setFrame(nextFrameIndex);
                    this.currentFrameIndex = nextFrameIndex; 
                    this.scene.wheat.tilePositionX += 16; 

                    if(this.scene.wheat.tilePositionX >= 16 * this.maxFrames)
                    {
                        this.scene.wheat.tilePositionX = 0;
                    }
                }
            }
        }
        
        class Ground
        {
            constructor(scene, worldWidthX)
            {
                this.frameCounter = 0;
                this.frameRate = 48;       
                this.maxFrames = 2;        
                this.width = worldWidthX;
                this.scene = scene;
                this.direction = 1;
                this.currentFrameIndex = 0;
                this.create();
                this.scene.events.on('update', this.update, this);
                this.scene.events.once('shutdown', () => 
                {
                    this.scene.events.off('update', this.update, this);
                });
            }

            create() 
            {
                this.scene.groundBotom = this.scene.add.tileSprite(0, this.scene.sys.game.config.height + 16, this.width * 2, 32, 'ground').setOrigin(0, 1);
                this.scene.physics.add.existing(this.scene.groundBotom);
                
                if(this.scene.groundBotom.body) 
                {
                    this.scene.groundBotom.body.setImmovable(true);
                    this.scene.groundBotom.body.allowGravity = false;
                }

                this.scene.grassTop = this.scene.add.tileSprite(0, this.scene.sys.game.config.height - 16, this.width, 16, 'grasstop', this.currentFrameIndex);
                this.scene.grassTop.setOrigin(0, 1);

                if(this.scene.player)
                {
                    this.scene.physics.add.collider(this.scene.player, this.scene.groundBotom);
                }
                if(this.scene.cults)
                {
                    this.scene.physics.add.collider(this.scene.cults, this.scene.groundBotom);
                }
                if(this.scene.cultKnifes)
                {
                    this.scene.physics.add.collider(this.scene.cultKnifes, this.scene.groundBotom);
                }
            }

            update(time, delta) 
            {
                this.frameCounter += 1;

                if(this.frameCounter % this.frameRate === 0) 
                {
                    let currentFrame = this.currentFrameIndex;

                    if(currentFrame === this.maxFrames - 1 && this.direction === 1) 
                    { 
                        this.direction = -1; 
                    } 
                    else if(currentFrame === 0 && this.direction === -1) 
                    {
                        this.direction = 1;  
                    }

                    let nextFrameIndex = currentFrame + this.direction;

                    this.scene.grassTop.setFrame(nextFrameIndex);
                    
                    this.currentFrameIndex = nextFrameIndex; 
                    
                    this.scene.grassTop.tilePositionX += 32; 
                    
                    if(this.scene.grassTop.tilePositionX >= 32 * this.maxFrames)
                    {
                        this.scene.grassTop.tilePositionX = 0;
                    }
                }
            }
        }
        
        class MainMenu extends Phaser.Scene
        {
            constructor()
            {
              super({key: 'MainMenu'});
            }

            preload()
            {

            }

            create ()
            {
                //START BASIC SETUP MainMenu


                this.input.setDefaultCursor('');
                const worldWidthX = this.sys.game.config.width * 3;
                this.physics.world.setBounds(0, 0, (worldWidthX / 3) - 120, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get('GameManager');
                this.HUD = this.scene.get('HUD');


                //END BASIC SETUP MainMenu


                //START PROPS BEFORE PLAYER MainMenu


                this.sky = this.add.tileSprite(0, -32, worldWidthX, this.sys.game.config.height + 32, 'sky').setOrigin(0, 0);
                this.sky.setScrollFactor(0.1);

                this.stars = this.add.tileSprite(0, 0, worldWidthX, this.sys.game.config.height, 'stars').setOrigin(0, 0);
                this.stars.setScrollFactor(0.1);

                this.barn = this.add.image
                (
                    (worldWidthX / 3) / 30,
                    this.sys.game.config.height - 16,
                    'barn'
                ).setOrigin(0, 1);
                this.barn.setScrollFactor(0.25);

                this.silo = this.add.image
                (
                    this.barn.width + (worldWidthX / 3) / 30,
                    this.sys.game.config.height - 16,
                    'silo'
                );
                this.silo.setOrigin(0, 1);
                this.silo.setScrollFactor(0.225);

                this.cross = this.add.image
                (
                    (worldWidthX / 3) + ((worldWidthX / 3) / 30),
                    this.sys.game.config.height - 16,
                    'cross'
                );
                this.cross.setOrigin(0, 1);
                this.cross.setScrollFactor(0.2);
                
                this.newWheat = new Wheat(this, worldWidthX);
                
                this.fence = this.add.tileSprite
                (
                    this.sys.game.config.width * (2/4) - 2,
                    this.sys.game.config.height - 16,
                    worldWidthX / 2 * (3 / 4) + 2,
                    16,
                    'fence'
                );
                this.fence.setScrollFactor(0.75);
                this.fence.setOrigin(0.5, 1);


                //END PROPS BEFORE PLAYER MainMenu


                //START PLAYER SETUP MainMenu


                createPlayer(this, Math.min(this.sys.game.config.width / 4, this.sys.game.config.width / 2), this.sys.game.config.height - 24, this.gameManager);
                this.player.buddha();


                //END PLAYER SETUP MainMenu


                //START ENEMY SETUP MainMenu


                //END ENEMY SETUP MainMenu


                //START PROPS AFTER PLAYER MainMenu


                this.copcar = this.add.image
                (
                    worldWidthX / 4 + this.sys.game.config.width / 4 - this.sys.game.config.width / 8,
                    this.sys.game.config.height - 16,
                    'copcar'
                ).setOrigin(1, 1);

                this.pipe = this.physics.add.sprite(worldWidthX / 2 + this.sys.game.config.width / 4 - 6, this.sys.game.config.height - 16, 'pipe');
                this.pipe.setOrigin(0, 1);
                this.pipe.body.allowGravity = false;
                this.pipe.body.setImmovable(true);

                if(!this.anims.get('stabAnim'))
                {
                    this.anims.create
                    ({
                        key: "stabAnim",
                        frames: this.anims.generateFrameNumbers('stab', {start: 0, end: 2 }),
                        frameRate: 2,
                        repeat: 0
                    });
                }
                this.stab = this.add.sprite(this.pipe.x + 1, this.pipe.y, "stab").setOrigin(0, 1);
                this.stab.setActive(false);
                this.stab.setVisible(false);

                this.physics.add.collider(this.pipe, this.player, (pipe, player) =>
                {
                    player.destroy();
                    this.stab.setActive(true);
                    this.stab.setVisible(true);
                    this.sound.play('powerup');

                    this.stab.on(Phaser.Animations.Events.ANIMATION_UPDATE, (anim, frame) => 
                    {
                        if(frame.index === 2) 
                        {
                            this.sound.play('stab');

                            this.controls.destroy();
                            this.strafeControls.destroy();
                            this.jumpControls.destroy();
                            this.leftClickControls.destroy();
                            this.rightClickControls.destroy();
                            this.pistolControls.destroy();
                            this.screenShake.destroy();
                            this.toggleHUD.destroy();
                        }
                    });

                    this.stab.play("stabAnim", true);
                });

                this.stab.on(Phaser.Animations.Events.ANIMATION_COMPLETE, () => 
                {
                    this.cameras.main.pan(worldWidthX, this.sys.game.config.height / 2, 2000, 'Sine.easeInOut');
                });
                
                this.ground = new Ground(this, worldWidthX);

                this.logo = createText(this, worldWidthX / 6, this.sys.game.config.height / 2, 'House Call', 20, '#fff').setOrigin(0.5, 0.5);
                this.logo.setInteractive({cursor: 'pointer'});

                this.physics.add.existing(this.logo, true);
                this.physics.add.collider(this.logo, this.playerBulletsHolder, (logo, bullet) =>
                {
                    bullet.destroy();
                    logo.destroy();
                    this.cameras.main.pan(worldWidthX / 2, this.sys.game.config.height / 2, 2000, 'Sine.easeInOut');

                    this.time.delayedCall(2000, () =>
                    {
                        this.player.x = worldWidthX / 3 - this.player.width / 2;
                        this.player.canMove = false;
                        this.tweens.add
                        ({
                            targets: this.player, 
                            x: worldWidthX / 3 + this.player.width / 2,               
                            y: this.sys.game.config.height - 24,               
                            duration: 250,       
                            ease: 'linear',       
                            onComplete: () => 
                            {
                                this.physics.world.setBounds(this.sys.game.config.width, 0, this.sys.game.config.width, 176);
                                this.player.canMove = true;
                            }
                        });
                    }, [], this);

                });
                
                this.controls = createText(this, worldWidthX / 2, 10, 'Controls:', 20, '#fff');

                this.strafeControls = createText(this, worldWidthX / 2, 0 + this.controls.height + 20, 'A/D: Walk', 12, '#fff');
                this.jumpControls = createText(this, worldWidthX / 2, 0 + this.controls.height + this.strafeControls.height + 25, 'Space: Jump', 12, '#fff');
                this.rightClickControls = createText(this, worldWidthX / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + 30, 'Right-Click: Block', 12, '#fff');
                this.leftClickControls = createText(this, worldWidthX / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + this.rightClickControls.height + 35, 'Left-Click: Use Shotgun (Hold)', 12, '#fff');
                this.pistolControls = createText(this, worldWidthX / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + this.rightClickControls.height + this.leftClickControls.height + 40, 'Q/E: Use Pistol', 12, '#fff');
            
                this.screenShake = createText(this, this.game.config.width * 2 - 3, 3, 'I: Toggle Jitter', 10, '#ff0000').setOrigin(1, 0).setDepth(1232300);
                
                this.highScore = createText(this, this.game.config.width * 3 - (this.game.config.width / 2), 3, 'High Score: ' + this.gameManager.highScore, 10, '#ff0000').setOrigin(0.5, 0).setDepth(1232300);
                
                this.toggleHUD = createText(this, this.game.config.width + 3, 3, 'U: Toggle HUD', 10, '#ff0000').setOrigin(0, 0).setDepth(1232300);
                
                this.start = createText(this, worldWidthX - this.sys.game.config.width / 2, this.sys.game.config.height / 2, 'Start', 20, '#fff').setOrigin(0.5, 0.5);
                this.start.setInteractive({cursor: 'pointer'});
                this.start.on('pointerdown', () =>
                {
                    this.scene.stop('MainMenu');
                    this.scene.stop('HUD');
                    event.stopPropagation();
                    this.scene.start('Level1Game');
                    this.scene.launch('HUD');
                });


                //END PROPS AFTER PLAYER MainMenu


                //START CAMERA SETUP MainMenu


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;
                this.cameras.main.setZoom(1);


                //END CAMERA SETUP MainMenu
            }

            update(time)
            {
                if(this.player.health < 1000)
                {
                    this.player.buddha();
                }
                
                this.sky.tilePositionX += 0.005;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
  
        function createText(scene, x, y, words, size, color)
        {
            let newText = scene.add.text(x, y, words, { fontSize: size, fill: color}).setOrigin(0.5, 0);
            return newText;
        }
  
        function makeRain(scene, texture)
        {
            scene.rain = scene.add.particles
            (
                0, 0, 
                texture,
                {
                    x: { min: 0, max: scene.sys.game.config.width + (scene.sys.game.config.width / 5) },
                    y: { min: -15, max:-7 },
                    angle: { min: 90, max: 180 }, 
                    speed: { min: 100, max: 300 },
                    gravityY: 100,
                    lifespan: { min: 1500, max: 1500 },
                    quantity: 15,
                    scale: { start: 0.35, end: 0.25 },
                    alpha: { start: 1, end: 0 },
                    blendMode: 'NORMAL',
                    frequency: 50
                }
            );

            scene.rain.start();
            scene.rain.setScrollFactor(0);
        }
  
        function filterColors(scene, color)
        {
            const itemsToTint = 
            [
                "shed", "fence", "couch", "grill", "groundBotom", "grassTop", "wheat", "cross", "barn", "silo", "tractor", "copcar"
            ];

            itemsToTint.forEach(propKey => 
            {
                const asset = scene[propKey];
                
                if(asset) 
                {
                    asset.setTint(color);     
                }
            });
        }
  
        function createRandomEnemies(scene, spawnList, worldWidthX, gameManager)
        {
            function getRandomCoords(worldWidthX) 
            {
                let min = 600;
                return Math.floor(Math.random() * (worldWidthX - min + 1)) + min;
            }

            function positionTaken(xCoord, chosenPositions, range)
            {
                for(const position of chosenPositions) 
                {
                    if(Math.abs(position - xCoord) <= range) 
                    {
                        return true;
                    }
                }

                return false;
            }

            const enemyData = new Map();

            for (const enemy of spawnList) 
            {
                const currentEnemy = enemy.type;
                const enemyAmount = enemy.amount;

                let positions = new Array();

                if(currentEnemy === 'cult')
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 8;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newCult = { x: xCoord, y: 100 };
                        chosenPositions.add(xCoord);
                        positions.push(newCult);
                    }

                    enemyData.set('cult', { positions: positions });
                    cultCreator(scene, positions, gameManager);
                }    
                else if(currentEnemy === 'cultKnife')
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 8;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newCultKnife = { x: xCoord, y: 100 };
                        chosenPositions.add(xCoord);
                        positions.push(newCultKnife);
                    }

                    enemyData.set('cultKnife', { positions: positions });
                    cultKnifeCreator(scene, positions, gameManager);
                }
                else if(currentEnemy === 'eye')
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 16;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newEye = { x: xCoord, y: 88 };
                        chosenPositions.add(xCoord);
                        positions.push(newEye);
                    }

                    enemyData.set('eye', { positions: positions });
                    eyeCreator(scene, positions, gameManager);
                }
            }

            return enemyData;
        }

        function getRandomXAnywhere(worldWidthX)
        {
            return (Math.floor(Math.random() * (worldWidthX - 0 + 1)) + 0);
        }

        function getRandMinMax(min, max)
        {
            return (Math.floor(Math.random() * (max - min + 1)) + min);
        }
        
        function makeLevelPropsRandomAfterWheat(scene, propData, worldWidthX)
        {
            if(!propData)
            {
                propData = 
                {
                    "fence":
                    {
                        name: "fence",
                        pos:  getRandomXAnywhere(worldWidthX * 0.75),
                        scrollFactor: 0.75,
                        display: getRandMinMax(1, 100) === 1 ? true : false,
                        tileSprite: true,
                        width:  (Math.floor(getRandMinMax(0, worldWidthX * 0.75 / 2) / 4) * 4) + 3,
                        positionOffset: -3
                    },
                    "couch":
                    {
                        name: "couch",
                        pos:  getRandomXAnywhere(worldWidthX * 0.775),
                        scrollFactor: 0.775,
                        flip: false,
                        display: getRandMinMax(1, 1000) === 1 ? true : false
                    },
                    "grill":
                    {
                        name: "grill",
                        pos:  getRandomXAnywhere(worldWidthX * 0.8),
                        scrollFactor: 0.8,
                        flip: false,
                        display: getRandMinMax(1, 1000) === 1 ? true : false
                    },
                    "copcar":
                    {
                        name: "copcar",
                        pos:  getRandomXAnywhere(worldWidthX * 1),
                        scrollFactor: 1,
                        flip: getRandMinMax(1, 10) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    }
                };
            }
            
            Object.entries(propData).forEach(([name, definition]) => 
            {
                if(definition.display)
                {
                    if(definition.tileSprite)
                    {
                        let offsetX = definition.positionOffset || 0;
                        scene[name] = scene.add.tileSprite(definition.pos, 176 - 16, definition.width, 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor);
                        scene[name].tilePositionX = offsetX;
                    }
                    else
                    {
                        scene[name] = scene.add.image(definition.pos, scene.sys.game.config.height - 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor).setFlipX(definition.flip);
                    }
                }
            });
            
            return propData;
        }
        
        function makeLevelPropsRandomBeforeWheat(scene, propData, worldWidthX)
        {
            if(!propData)
            {
                propData = 
                {
                    "silo":
                    {
                        name: "silo",
                        pos:  getRandomXAnywhere(worldWidthX * 0.17),
                        scrollFactor: 0.17,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "barn":
                    {
                        name: "barn",
                        pos:  getRandomXAnywhere(worldWidthX *  0.2),
                        scrollFactor: 0.2,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "cross":
                    {
                        name: "cross",
                        pos:  getRandomXAnywhere(worldWidthX * 0.25),
                        scrollFactor: 0.25,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "shed":
                    {
                        name: "shed",
                        pos:  getRandomXAnywhere(worldWidthX * 0.325),
                        scrollFactor: 0.325,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "scarecrow":
                    {
                        name: "scarecrow",
                        pos:  getRandomXAnywhere(worldWidthX * 0.4),
                        scrollFactor: 0.4,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "tractor":
                    {
                        name: "tractor",
                        pos:  getRandomXAnywhere(worldWidthX * 0.45),
                        scrollFactor: 0.45,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    }
                };
            }
            
            Object.entries(propData).forEach(([name, definition]) => 
            {
                if(definition.display)
                {
                    scene[name] = scene.add.image(definition.pos, scene.sys.game.config.height - 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor).setFlipX(definition.flip);
                }
            });
            
            return propData;
        }
    
        class Level1Game extends Phaser.Scene
        {
            constructor()
            {
                super({ key: 'Level1Game' });
            }

            preload()
            {

            }

            create()
            {
                //START BASIC SETUP Level1Game


                this.input.setDefaultCursor('');
                const worldWidthX = 1800;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get('GameManager');
                this.HUD = this.scene.get('HUD');
                this.gameManager.updateHighestLevel(1);
                this.gameManager.updateCurrentLevel(1);


                //END BASIC SETUP Level1Game


                //START PROPS BEFORE PLAYER Level1Game


                this.sky = this.add.tileSprite(0, -32, worldWidthX, this.sys.game.config.height + 32, 'sky').setOrigin(0, 0);
                this.sky.setScrollFactor(0.1);

                this.stars = this.add.tileSprite(0, 0, worldWidthX, this.sys.game.config.height, 'stars').setOrigin(0, 0);
                this.stars.setScrollFactor(0.1);
                
                this.gameManager.level1BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level1BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level1AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level1AfterPropData, worldWidthX);


                //END PROPS BEFORE PLAYER Level1Game


                //START PLAYER SETUP Level1Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level1Game


                //START ENEMY SETUP Level1Game


                if(this.gameManager.level1Data === null)
                { 
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(2, 3) },
                                { type: 'cultKnife', amount: getRandMinMax(4, 5) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(2, 3) },
                                { type: 'cultKnife', amount: getRandMinMax(3, 5) }                            
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(2, 2) },
                                { type: 'cultKnife', amount: getRandMinMax(4, 6) }
                            ];
                            break;
                    }

                    this.gameManager.level1Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                {
                    for(const enemy of this.gameManager.level1Data.keys()) 
                    {
                        if(enemy === 'cult')
                        {
                            let enemyData = this.gameManager.level1Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'cultKnife')
                        {
                            let enemyData = this.gameManager.level1Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level1Game


                //START PROPS AFTER PLAYER Level1Game


                const thisLevel = 1;
                this.pipe = new pipeNext(this, 1594, this.sys.game.config.height - 16, 'Level2Game', thisLevel, this.gameManager);

                this.ground = new Ground(this, worldWidthX);


                //END PROPS AFTER PLAYER Level1Game


                //START CAMERA SETUP Level1Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level1Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop('Level1Game');
                    this.scene.stop('HUD');
                    this.scene.start('Level1Game');
                    this.scene.launch('HUD');
                }

                cultSeparation(this.cults, this.player);
                
                this.sky.tilePositionX += 0.005;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }

        class Level2Game extends Phaser.Scene
        {
            constructor()
            {
                super({ key: 'Level2Game' });
            }

            preload()
            {

            }

            create()
            {
                //START BASIC SETUP Level2Game


                this.input.setDefaultCursor('');
                const worldWidthX = 2250;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get('GameManager');
                this.HUD = this.scene.get('HUD');
                this.gameManager.updateHighestLevel(2);
                this.gameManager.updateCurrentLevel(2);


                //END BASIC SETUP Level2Game


                //START PROPS BEFORE PLAYER Level2Game


                this.sky = this.add.tileSprite(0, -32, worldWidthX, this.sys.game.config.height + 32, 'sky').setOrigin(0, 0);
                this.sky.setScrollFactor(0.1);
                this.sky.postFX.addColorMatrix().grayscale(1);   
                        
                this.gameManager.level2BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level2BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level2AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level2AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, 'pipe');       
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level2Game


                //START PLAYER SETUP Level2Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level2Game


                //START ENEMY SETUP Level2Game


                if(this.gameManager.level2Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(8, 12) },
                                { type: 'cultKnife', amount: getRandMinMax(1, 1) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(10, 13) },
                                { type: 'cultKnife', amount: getRandMinMax(1, 2) }
                            ];
                            break;
                            
                        case 3:
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(8, 15) },
                                { type: 'cultKnife', amount: getRandMinMax(1, 2) }
                            ];
                            break;
                    }
                    

                    this.gameManager.level2Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level2Data.keys()) 
                    {
                        if(enemy === 'cult')
                        {
                            let enemyData = this.gameManager.level2Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'cultKnife')
                        {
                            let enemyData = this.gameManager.level2Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level2Game


                //START PROPS AFTER PLAYER Level2Game


                const thisLevel = 2;
                this.pipe = new pipeNext(this, 2044, this.sys.game.config.height - 16, 'Level3Game', 2, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                makeRain(this, 'raindrop');

                filterColors(this, 0xd1e0e0);


                //END PROPS AFTER PLAYER Level2Game


                //START CAMERA SETUP Level2Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level2Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop('Level2Game');
                    this.scene.stop('HUD');
                    this.scene.start('Level1Game');
                    this.scene.launch('HUD');
                }

                cultSeparation(this.cults, this.player);
                
                this.sky.tilePositionX += 0.01;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }

        class Level3Game extends Phaser.Scene
        {
            constructor()
            {
              super({key: 'Level3Game'});
            }

            create()
            {
                //START BASIC SETUP Level3Game


                this.input.setDefaultCursor('');
                const worldWidthX = 1325;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get('GameManager');
                this.HUD = this.scene.get('HUD');
                this.gameManager.updateHighestLevel(3);
                this.gameManager.updateCurrentLevel(3);


                //END BASIC SETUP Level3Game


                //START PROPS BEFORE PLAYER Level3Game


                this.sky = this.add.tileSprite(0, -32, worldWidthX, this.sys.game.config.height + 32, 'redskyrain').setOrigin(0, 0);
                this.sky.setScrollFactor(0.1);
                                    
                this.gameManager.level3BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level3BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level3AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level3AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, 'pipe');
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level3Game


                //START PLAYER SETUP Level3Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);
                //this.player.buddha();


                //END PLAYER SETUP Level3Game


                //START ENEMY SETUP Level3Game


                if(this.gameManager.level3Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(2, 4) },
                                { type: 'cultKnife', amount: getRandMinMax(6, 8) },
                                { type: 'eye', amount: getRandMinMax(2, 4) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(2, 4) },
                                { type: 'cultKnife', amount: getRandMinMax(2, 4) },
                                { type: 'eye', amount: getRandMinMax(6, 8) }
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(6, 8) },
                                { type: 'cultKnife', amount: getRandMinMax(2, 4) },
                                { type: 'eye', amount: getRandMinMax(2, 4) }
                            ];
                            break;
                    }

                    this.gameManager.level3Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level3Data.keys()) 
                    {
                        if(enemy === 'cult')
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'cultKnife')
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'eye')
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            eyeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level3Game


                //START PROPS AFTER PLAYER Level3Game


                const thisLevel = 3;
                this.pipe = new pipeNext(this, 1119, this.sys.game.config.height - 16, 'Level4Game', thisLevel, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                makeRain(this, 'bloodrain');

                filterColors(this, 0xffcccc);


                //END PROPS AFTER PLAYER Level3Game


                //START CAMERA SETUP Level3Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level3Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop('Level3Game');
                    this.scene.stop('HUD');
                    this.scene.start('Level2Game');
                    this.scene.launch('HUD');
                }

                cultSeparation(this.cults, this.player);
                eyeSeparation(this.eyes, this.player);
                
                this.sky.tilePositionX += 0.01;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
  
        class Level4Game extends Phaser.Scene
        {
            constructor()
            {
              super({key: 'Level4Game'});
            }

            create()
            {
                //START BASIC SETUP Level4Game


                this.input.setDefaultCursor('');
                const worldWidthX = 2400;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get('GameManager');
                this.HUD = this.scene.get('HUD');
                this.gameManager.updateHighestLevel(4);
                this.gameManager.updateCurrentLevel(4);


                //END BASIC SETUP Level4Game


                //START PROPS BEFORE PLAYER Level4Game


                this.sky = this.add.tileSprite(0, -32, worldWidthX, this.sys.game.config.height + 32, 'redsky').setOrigin(0, 0);
                this.sky.setScrollFactor(0.1);
                                                
                this.gameManager.level4BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level4BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level4AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level4AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, 'pipe');
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level4Game


                //START PLAYER SETUP Level4Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level4Game


                //START ENEMY SETUP Level4Game


                if(this.gameManager.level4Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(19, 21) },
                                { type: 'cultKnife', amount: getRandMinMax(4, 5) },
                                { type: 'eye', amount: getRandMinMax(6, 8) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(17, 19) },
                                { type: 'cultKnife', amount: getRandMinMax(2, 4) },
                                { type: 'eye', amount: getRandMinMax(8, 10) }
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: 'cult', amount: getRandMinMax(19, 21) },
                                { type: 'cultKnife', amount: getRandMinMax(1, 1) },
                                { type: 'eye', amount: getRandMinMax(6, 8) }
                            ];
                            break;
                    }
                    
                    this.gameManager.level4Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level4Data.keys()) 
                    {
                        if(enemy === 'cult')
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'cultKnife')
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === 'eye')
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            eyeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level4Game


                //START PROPS AFTER PLAYER Level4Game


                const thisLevel = 4;
                this.pipe = new pipeNext(this, 2206, this.sys.game.config.height - 16, 'MainMenu', 4, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                filterColors(this, 0xff9999);


                //END PROPS AFTER PLAYER Level4Game


                //START CAMERA SETUP Level4Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level4Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop('Level4Game');
                    this.scene.stop('HUD');
                    this.scene.start('Level3Game');
                    this.scene.launch('HUD');
                }

                cultSeparation(this.cults, this.player);
                eyeSeparation(this.eyes, this.player);
                
                this.sky.tilePositionX += 0.02;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
  
        class UpgradeRoom extends Phaser.Scene
        {
            constructor()
            {
                super({key: 'UpgradeRoom'});
                
                this.gameManager = game.scene.getScene('GameManager');
                this.cardAmount = Object.keys(this.gameManager.upgradeCardData).length;
                this.upgradeCardData = this.gameManager.upgradeCardData;
            }

            create()
            {
                this.input.setDefaultCursor('pointer');


                //START CARD SETUP


                let card1;
                let card2;

                do
                {
                    card1 = this.getRandomCardId();
                }
                while(this.gameManager.ownedCards.has(card1))

                do
                {
                    card2 = this.getRandomCardId();
                }
                while(card2 === card1 || this.gameManager.ownedCards.has(card2) || (this.gameManager.ammoUpgrades.has(card1) && this.gameManager.ammoUpgrades.has(card2)))

                this.cardDisplay1 = this.displayCard(card1, 'left');
                this.cardDisplay1.on('pointerdown', () =>
                {
                    this.acceptCard(card1);
                });

                this.cardDisplay2 = this.displayCard(card2, 'right');
                this.cardDisplay2.on('pointerdown', () =>
                {
                    this.acceptCard(card2);
                }); 


                //END CARD SETUP
            }

            update(time, delta)
            {

            }

            acceptCard(id)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                card.effect(this.gameManager);
                this.gameManager.ownedCards.add(id); 
                transitionLevels(this, this.gameManager);
            }

            getRandomCardId()
            {
                return Math.floor(Math.random() * (this.cardAmount - 1 + 1)) + 1;
            }

            displayCard(id, position)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                let titleText;
                let descriptionText;
                let icon;
                let xPos;
                const yCenter = this.sys.game.config.height / 2;

                if(position === 'left')
                {
                    xPos = this.sys.game.config.width / 4;
                }
                else
                {
                    xPos = (this.sys.game.config.width / 4) * 3;
                }

                const cardContainer = this.add.container(xPos, yCenter);
                titleText = createText(this, 0, -50, card.name, 20, '#f00').setOrigin(0.5, 1);
                descriptionText = createText(this, 0, 50, card.description, 12, '#f00').setOrigin(0.5, 0);
                descriptionText.setStyle
                ({
                    wordWrap: { width: this.sys.game.config.width / 2 - 10, use:'true' }
                });

                if(card.icon)
                {
                    icon = this.add.image
                    (
                      xPos,
                      yCenter,
                      card.icon
                    ).setOrigin(0.5, 0.5);
                }

                cardContainer.add([titleText, descriptionText]);

                const hitAreaWidth = this.sys.game.config.width / 2;
                const hitAreaHeight = this.sys.game.config.height;

                const hitArea = new Phaser.Geom.Rectangle
                (
                    -hitAreaWidth / 2,
                    -hitAreaHeight / 2,
                    hitAreaWidth,
                    hitAreaHeight
                );

                cardContainer.setInteractive(hitArea, Phaser.Geom.Rectangle.Contains);

                return cardContainer;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
  
        class GameManager extends Phaser.Scene
        {
            constructor()
            {
                super({ key: 'GameManager' });

                this.upgradeCardData = 
                {
                    'birdshot': 
                    {
                        id: 1,
                        name: 'Birdshot',
                        description: 'Replace shells with birdshot.',
                        icon: 'birdshoticon',
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = 'birdshot';
                        }
                    },
                    'slugs': 
                    {
                        id: 2,
                        name: 'Slugs',
                        description: 'Replace shells with slugs.',
                        icon: 'slugicon',
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = 'slug';
                        }
                    },
                    'damage': 
                    {
                        id: 3,
                        name: 'Gun Oil',
                        description: 'Increase shotgun damage by 25%.',
                        icon: 'damageicon',
                        effect: (gameManager) => 
                        {
                            gameManager.damageUpgrade = true;
                        }
                    }, 
                    'health': 
                    {
                        id: 4,
                        name: 'Conditioning',
                        description: 'Survive an extra hit.',
                        icon: 'healthicon',
                        effect: (gameManager) => 
                        {
                            gameManager.healthUpgrade = true;
                        }
                    },
                    'doubleFire': 
                    {
                        id: 5,
                        name: 'Veneration',
                        description: 'Successful kills trigger double fire rate.',
                        icon: 'cultenergyicon',
                        effect: (gameManager) => 
                        {
                            gameManager.doubleFireUpgrade = true;
                        }
                    },
                    'pistolDamage': 
                    {
                        id: 6,
                        name: 'Hollow Points',
                        description: 'Double handgun damage.',
                        icon: 'hollowpointsicon',
                        effect: (gameManager) => 
                        {
                            gameManager.pistolUpgrade = true;
                        }
                    },
                    'multiAmmo': 
                    {
                        id: 7,
                        name: 'Random Shells',
                        description: 'Replace shells with random ones.',
                        icon: 'multiammoicon',
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = true;
                        }
                    },
                    'triplepistol': 
                    {
                        id: 8,
                        name: 'Panic',
                        description: 'Fire three handgun rounds in one activation. Higher cooldown.',
                        icon: 'triplepistolicon',
                        effect: (gameManager) => 
                        {
                            gameManager.triplePistolUpgrade = true;
                            gameManager.quintuplePistolUpgrade = false;
                        }
                    },
                    'quintuplepistol': 
                    {
                        id: 9,
                        name: 'Terror',
                        description: 'Fire five handgun rounds in one activation. Much higher cooldown.',
                        icon: 'quintuplepistolicon',
                        effect: (gameManager) => 
                        {
                            gameManager.triplePistolUpgrade = false;
                            gameManager.quintuplePistolUpgrade = true;
                        }
                    },
                    'mousepistol': 
                    {
                        id: 10,
                        name: 'Center Mass',
                        description: 'Handgun aims with mouse.',
                        icon: 'mousepistolicon',
                        effect: (gameManager) => 
                        {
                            gameManager.mousePistolUpgrade = true;
                        }
                    },
                    'numfourbuckshot': 
                    {
                        id: 11,
                        name: '#4 Buckshot',
                        description: 'Replace shells with #4 buckshot.',
                        icon: 'numfourbuckshoticon',
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = 'numfourbuckshot';
                        }
                    },
                    '000buckshot': 
                    {
                        id: 12,
                        name: '000 Buckshot',
                        description: 'Replace shells with 000 buckshot.',
                        icon: '000buckshoticon',
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = '000buckshot';
                        }
                    }
                };

                this.ammoUpgrades = new Set([1, 2, 7, 11, 12]);

                this.highestLevel = 0;
                this.initialHighestLevel = this.highestLevel;
                this.currentLevel = 0;
                this.visitedUpgradeRoom1 = false;
                this.visitedUpgradeRoom2 = false;
                this.visitedUpgradeRoom3 = false;
                this.score = 0;
                this.highScore = 0;
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCHighScore")) !== null)
                    {
                        this.highScore = parseInt(localStorage.getItem("HCHighScore"));
                    }
                }

                this.ownedCards = new Set();

                this.fireModeUpgrade = 'buckshot';
                this.damageUpgrade = false;
                this.blockUpgrade = false;
                this.healthUpgrade = false;
                this.doubleFireUpgrade = false;
                this.pistolUpgrade = false;
                this.multiAmmoUpgrade = false;
                this.triplePistolUpgrade = false;
                this.quintuplePistolUpgrade = false;
                this.mousePistolUpgrade = false;

                this.level1Data = null;
                this.level2Data = null;
                this.level3Data = null;
                this.level4Data = null;
                
                this.level1BeforePropData = null;
                this.level2BeforePropData = null;
                this.level3BeforePropData = null;
                this.level4BeforePropData = null;
                
                this.level1AfterPropData = null;
                this.level2AfterPropData = null;
                this.level3AfterPropData = null;
                this.level4AfterPropData = null;
                
                this.alwaysBuddha = false;

                this.alwaysDisplayUpgrades = true;
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCHUDSetting")) !== null)
                    {
                        this.alwaysDisplayUpgrades = JSON.parse(localStorage.getItem("HCHUDSetting"));
                    }
                }

                this.allowScreenShakeOnBlock = true;
                this.allowScreenShakeOnKill = true;
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCScreenShakeSetting")) !== null)
                    {
                        this.allowScreenShakeOnBlock = JSON.parse(localStorage.getItem("HCScreenShakeSetting"));
                        this.allowScreenShakeOnKill = JSON.parse(localStorage.getItem("HCScreenShakeSetting"));
                    }
                }
            }

            create()
            {
                this.wasd =
                {
                    i: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I)
                };
            }

            update(time, delta)
            {
                if(Phaser.Input.Keyboard.JustDown(this.wasd.i))
                {
                    this.allowScreenShakeOnBlock = !this.allowScreenShakeOnBlock;
                    this.allowScreenShakeOnKill = !this.allowScreenShakeOnKill;
                    
                    if(checkStorage() === true)
                    {
                        localStorage.setItem("HCScreenShakeSetting", this.allowScreenShakeOnBlock);
                    }
                }
            }

            clearAmmoOwned()
            {
                for(const ownedCard of this.ownedCards)
                {
                    if(this.ammoUpgrades.has(ownedCard))
                    {
                        this.ownedCards.delete(ownedCard);
                    }
                }
            }

            returnCardNameFromId(id)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                return card.name;
            }

            updateHighestLevel(newHigh)
            {
                if(newHigh > this.highestLevel)
                {
                    this.highestLevel = newHigh;
                }
            }

            updateCurrentLevel(newCurrent)
            {
                this.currentLevel = newCurrent;
            }

            reset()
            {
                this.highestLevel = 0;
                this.initialHighestLevel = this.highestLevel;
                this.currentLevel = 0;
                this.visitedUpgradeRoom1 = false;
                this.visitedUpgradeRoom2 = false;
                this.visitedUpgradeRoom3 = false;

                this.ownedCards = new Set();

                this.fireModeUpgrade = 'buckshot';
                this.damageUpgrade = false;
                this.blockUpgrade = false;
                this.healthUpgrade = false;
                this.doubleFireUpgrade = false;
                this.pistolUpgrade = false;
                this.multiAmmoUpgrade = false;
                this.triplePistolUpgrade = false;
                this.quintuplePistolUpgrade = false;
                this.mousePistolUpgrade = false;

                this.level1Data = null;
                this.level2Data = null;
                this.level3Data = null;
                this.level4Data = null;
                
                this.level1BeforePropData = null;
                this.level2BeforePropData = null;
                this.level3BeforePropData = null;
                this.level4BeforePropData = null;
                
                this.level1AfterPropData = null;
                this.level2AfterPropData = null;
                this.level3AfterPropData = null;
                this.level4AfterPropData = null;
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
  
        class HUD extends Phaser.Scene
        {
            constructor()
            {
                super({ key: 'HUD' });
            }

            create()
            {
                this.wasd =
                {
                    u: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.U)
                };

                this.gameManager = this.scene.get('GameManager');
                this.displayedMessage = false;

                if(this.gameManager.alwaysDisplayUpgrades === true)
                { 
                    this.displayHighScore();
                    this.displayCurrentScore();
                    this.displayedMessage = true;
                }
                else
                {
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.displayedMessage = false;
                }
            }
            
            displayCurrentScore()
            {
                this.currentScore = createText(this, 3, 3, 'Score: ' + this.gameManager.score, 10, '#ff0000').setOrigin(0, 0).setDepth(1232300);
            }
            
            destroyCurrentScore()
            {
                if(this.currentScore)
                {
                    this.currentScore.destroy();
                    this.currentScore = null;
                }
            }
            
            displayHighScore()
            {
                this.highScore = createText(this, this.game.config.width - 3, 3, 'High Score: ' + this.gameManager.highScore, 10, '#ff0000').setOrigin(1, 0).setDepth(1232300);
            }
            
            destroyHighScore()
            {
                if(this.highScore)
                {
                    this.highScore.destroy();
                    this.highScore = null;
                }
            }
            
            updateHighScore()
            {
                if(this.highScore)
                {
                    this.highScore.setText('High Score: ' + this.gameManager.highScore);
                }
            }
            
            updateScore()
            {
                if(this.currentScore)
                {
                    this.currentScore.setText('Score: ' + this.gameManager.score);
                }
            }

            update(time)
            {
                if(Phaser.Input.Keyboard.JustDown(this.wasd.u))
                {
                    if(this.displayedMessage)
                    {
                        this.destroyCurrentScore();
                        this.destroyHighScore();
                        this.gameManager.alwaysDisplayUpgrades = false;
                    }
                    else
                    {
                        this.displayCurrentScore();
                        this.displayHighScore();
                        this.gameManager.alwaysDisplayUpgrades = true;
                    }

                    this.displayedMessage = !this.displayedMessage;
                    
                    if(checkStorage() === true)
                    {
                        localStorage.setItem("HCHUDSetting", this.gameManager.alwaysDisplayUpgrades);
                    }
                }
            }
            
            shutdown() 
            {
                this.children.list.forEach(child => 
                {
                    if(child.destroy) 
                    {
                        child.destroy();
                    }
                });
            }
        }
        
        function checkStorage()
        {
            var test = "test";
    
            try 
            {
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
            return true;
            } 
                catch(e)
            {
                    return false;
            }
        }
        
        document.addEventListener('contextmenu', event => 
        {
            event.preventDefault();
            return false;
        });
  
        const config =
        {
            type: Phaser.AUTO,
            pixelArt: true,
            width: Math.max(400, Math.min(400, (window.innerWidth / window.innerHeight) * 176)),
            height: 176,

            audio:
            {
                pauseOnBlur: true
            },

            scale:
            {
              mode: Phaser.Scale.FIT,
              autoCenter: Phaser.Scale.CENTER_BOTH
            },

            physics:
            {
              default: 'arcade',
              arcade:
              {
                gravity: { y: 300 },
                debug: false
              }
            },

            scene:
            [
              Loading,
              MainMenu,
              GameManager,
              UpgradeRoom,
              Level1Game,
              Level2Game,
              Level3Game,
              Level4Game,
              HUD
            ]
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>