<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>House Call</title>
  <meta name="description" content="2d video game">
  <script src="./assets/phaser3.90.0.min.js"></script>
  <link rel="shortcut icon" type="image" href="./assets/cultknifelogo.png">
  <style type="text/css">
    html {
        cursor: none !important;
    }
    canvas{
        cursor: none !important;
    }
      
    body {
      margin: 0;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background-color: black;
      overflow: hidden;
      cursor: none !important;
    }
  </style>
</head>
<body>
    <script type="text/javascript" src="./player.js"></script>
    <script type="text/javascript" src="./cult.js"></script>
    <script type="text/javascript" src="./cultKnife.js"></script>
    <script type="text/javascript" src="./eye.js"></script>
    <script type="text/javascript">
        class pipeNext extends Phaser.Physics.Arcade.Sprite
        {
            constructor(scene, x, y, key, fromLevel, gameManager) 
            {
                super(scene, x, y, "pipe");

                this.pipe = scene.physics.add.sprite(x, y, "pipe");
                this.pipe.setOrigin(0, 1);
                this.pipe.body.allowGravity = false;
                this.pipe.body.setImmovable(true);

                if(!scene.anims.get("stabAnim"))
                {
                    scene.anims.create
                    ({
                        key: "stabAnim",
                        frames: this.anims.generateFrameNumbers("stab", {start: 0, end: 2 }),
                        frameRate: 2,
                        repeat: 0
                    });
                }
                scene.stab = scene.add.sprite(this.pipe.x + 1, this.pipe.y, "stab").setOrigin(0, 1);
                scene.stab.setActive(false);
                scene.stab.setVisible(false);

                scene.physics.add.collider(this.pipe, scene.player, (pipe, player) =>
                {
                    player.destroy();
                    scene.stab.setActive(true);
                    scene.stab.setVisible(true);
                    scene.sound.play("powerup");

                    scene.stab.on(Phaser.Animations.Events.ANIMATION_UPDATE, (anim, frame) => 
                    {
                        if(frame.index === 2) 
                        {
                            let aCultActive = false;
                            scene.sound.play("stab");

                            if(scene.cults && scene.cults.children.entries)
                            {
                                const cultsArray = scene.cults.children.entries; 

                                for(let i = cultsArray.length - 1; i >= 0; i--) 
                                {
                                    const cult = cultsArray[i];
                                    aCultActive = true;
                                    cult.hitFrom = "pipe";
                                    cult.kill();  
                                }
                            }

                            if(scene.cultKnifes && scene.cultKnifes.children.entries)
                            {
                                const cultKnifesArray = scene.cultKnifes.children.entries; 

                                for(let i = cultKnifesArray.length - 1; i >= 0; i--) 
                                {
                                    const cultKnife = cultKnifesArray[i];
                                    aCultActive = true;
                                    cult.hitFrom = "pipe";
                                    cultKnife.kill();  
                                }
                            }

                            if(scene.eyes && scene.eyes.children.entries)
                            {
                                const eyesArray = scene.eyes.children.entries; 

                                for(let i = eyesArray.length - 1; i >= 0; i--) 
                                {
                                    const eye = eyesArray[i];
                                    aCultActive = true;
                                    cult.hitFrom = "pipe";
                                    eye.kill();  
                                }
                            }

                            if(aCultActive)
                            {
                                scene.sound.play("hurt");
                            }
                        }
                    });
                    scene.stab.play("stabAnim", true);
                });

                scene.stab.on(Phaser.Animations.Events.ANIMATION_COMPLETE, () => 
                {
                    transitionLevels(scene, gameManager);
                });
            }
        }
  
        function transitionLevels(scene, gameManager)
        {
            if(gameManager.currentLevel === 1)
            {
                if(gameManager.visitedUpgradeRoom1 === true)
                {
                    scene.scene.start("Level2Game");
                    scene.scene.launch("HUD");
                }
                else
                {
                    gameManager.visitedUpgradeRoom1 = true;
                    scene.scene.start("UpgradeRoom");
                    scene.scene.stop("HUD");
                }
            }
            else if(gameManager.currentLevel === 2)
            {
                if(gameManager.visitedUpgradeRoom2 === true)
                {
                    scene.scene.start("Level3Game");
                    scene.scene.launch("HUD");
                }
                else
                {
                    gameManager.visitedUpgradeRoom2 = true;
                    scene.scene.start("UpgradeRoom");
                    scene.scene.stop("HUD");
                }
            }
            else if(gameManager.currentLevel === 3)
            {
                if(gameManager.visitedUpgradeRoom3 === true)
                {
                    scene.scene.start("Level4Game");
                    scene.scene.launch("HUD");
                }
                else
                {
                    gameManager.visitedUpgradeRoom3 = true;
                    scene.scene.start("UpgradeRoom");
                    scene.scene.stop("HUD");
                }
            }
            else if(gameManager.currentLevel === 4)
            {
                scene.scene.stop("HUD");
                scene.gameManager.reset();
                scene.scene.start("Level1Game");
                scene.scene.launch("HUD");
            }
        }
        
        class Crosshair extends Phaser.Scene
        {
            constructor()
            {
                super({key: "Crosshair"});
            }
            
            create()
            {
                this.crosshair = this.add.image
                (
                    0,
                    0,
                    "crosshair"
                );
            }
            
            update()
            {
                this.crosshair.x = this.input.activePointer.x;
                this.crosshair.y = this.input.activePointer.y;
            }
        }

        class Loading extends Phaser.Scene
        {
            constructor()
            {
              super({key: "Loading"});
            }

            preload()
            {
                this.load.image("sky", "assets/sky.png");
                this.load.spritesheet("player", "assets/player.png", {frameWidth: 16, frameHeight: 16});
                this.load.image("ground", "assets/grass.png");
                this.load.image("bullet", "assets/bullet.png");
                this.load.image("barn", "assets/barn.png");
                this.load.image("fence", "assets/fence.png");
                this.load.image("stars", "assets/stars.png");
                this.load.image("cross", "assets/cross.png");
                this.load.spritesheet("cult", "./assets/cult.png", {frameWidth: 16, frameHeight: 16});
                this.load.image("couch", "./assets/couch.png");
                this.load.image("tractor", "./assets/tractor.png");
                this.load.spritesheet("grasstop", "./assets/grasstop.png", {frameWidth: 32, frameHeight: 16});
                this.load.image("grill", "./assets/grill.png");
                this.load.spritesheet("cultknife", "./assets/cultknife.png", {frameWidth: 16, frameHeight: 16});
                this.load.image("copcar", "./assets/copcar.png");
                this.load.image("cultorb", "./assets/cultorb.png");
                this.load.spritesheet("wheat", "./assets/wheat.png", {frameWidth: 16, frameHeight: 16});
                this.load.image("shed", "./assets/shed.png");
                this.load.image("silo", "./assets/silo.png");
                this.load.image("scarecrow", "./assets/scarecrow.png");
                this.load.image("pipe", "./assets/pipe.png");
                this.load.image("eye", "./assets/eye.png");
                this.load.spritesheet("stab", "./assets/stab.png", {frameWidth: 12, frameHeight: 18});
                this.load.image("blood", "assets/bloodparticle.png");
                this.load.image("eyechunk", "assets/eyechunk.png");
                this.load.image("shell", "assets/shell.png");
                this.load.image("raindrop", "assets/raindrop.png");
                this.load.image("bloodrain", "assets/bloodrain.png");
                this.load.image("redsky", "assets/redsky.png");
                this.load.image("redskyrain", "assets/redskyrain.png");
                this.load.image("bulletcult", "assets/bulletcult.png");
                this.load.image("slug", "assets/slug.png");
                this.load.image("slugcult", "assets/slugcult.png");
                this.load.image("slugshell", "assets/slugshell.png");
                this.load.image("slugicon", "assets/slugicon.png");
                this.load.image("birdshotshell", "assets/birdshotshell.png");
                this.load.image("birdshoticon", "assets/birdshoticon.png");
                this.load.image("healthicon", "assets/healthicon.png");
                this.load.image("shieldicon", "assets/shieldicon.png");
                this.load.image("damageicon", "assets/damageicon.png");
                this.load.image("cultenergyicon", "assets/cultenergyicon.png");
                this.load.image("hollowpointsicon", "assets/hollowpointsicon.png");
                this.load.image("pistolcasing", "assets/pistolcasing.png");
                this.load.image("multiammoicon", "assets/multiammoicon.png");
                this.load.image("triplepistolicon", "assets/triplepistolicon.png");
                this.load.image("quintuplepistolicon", "assets/quintuplepistolicon.png");
                this.load.image("mousepistolicon", "assets/mousepistolicon.png");
                this.load.image("numfourbuckshotshell", "assets/numfourbuckshotshell.png");
                this.load.image("numfourbuckshoticon", "assets/numfourbuckshoticon.png");
                this.load.image("000buckshoticon", "assets/000buckshoticon.png");
                this.load.image("bonegib", "assets/bonegib.png");
                this.load.image("organgib", "assets/organgib.png");
                this.load.image("headgib", "assets/headgib.png");
                this.load.image("ribcagegib", "assets/ribcagegib.png");
                this.load.image("crosshair", "assets/crosshair.png");

                this.load.audio("shotgunshot", 
                [
                    "assets/shotgunshot.wav"
                ]);

                this.load.audio("slug", 
                [
                    "assets/slug.wav"
                ]);

                this.load.audio("orbthrow", 
                [
                    "assets/orbthrow.wav"
                ]);

                this.load.audio("hurt", 
                [
                    "assets/hurt.wav"
                ]);

                this.load.audio("powerup", 
                [
                    "assets/powerup.wav"
                ]);

                this.load.audio("block", 
                [
                    "assets/block.wav"
                ]);

                this.load.audio("stab", 
                [
                    "assets/stab.wav"
                ]);

                this.load.audio("eyeorb", 
                [
                    "assets/eyeorb.wav"
                ]);

                this.load.audio("birdshot", 
                [
                    "assets/birdshot.wav"
                ]);

                this.load.audio("pistolsound", 
                [
                    "assets/pistolsound.wav"
                ]);
                
                this.load.audio("000buckshot", 
                [
                    "assets/000buckshot.wav"
                ]);
                
                this.load.audio("numfourbuckshot", 
                [
                    "assets/numfourbuckshot.wav"
                ]);
                
                this.load.font("hcfont", "./assets/Metamorphous-Regular.ttf");
            }

            create()
            {
                this.loading = this.add.text((this.sys.game.config.width / 2), this.sys.game.config.height / 2, "Loading", { fontFamily: "hcfont", fontSize: "16px", fill: "#fff" }).setOrigin(0.5);
            }

            update()
            {
                this.scene.stop("Loading");
                this.scene.start("GameManager");
                this.scene.start("MainMenu");
                this.scene.start("Settings");
                this.scene.start("Crosshair");
            }
        }
        
        function restartToMainMenu(scene)
        {
            scene.gameManager.reset();
            const activeScenes = scene.scene.manager.getScenes(true);
            activeScenes.forEach(s => 
            {
                const key = s.scene.key;
                if (key !== "GameManager" && key !== "Settings") 
                {
                    scene.scene.stop(key);
                }
            });

            scene.scene.launch("MainMenu");
            scene.scene.launch("Crosshair");

            scene.scene.sendToBack("MainMenu");
            scene.scene.bringToTop("Settings");
            scene.scene.bringToTop("Crosshair");
        }
        
         function restartToLevel1(scene)
        {
            scene.gameManager.reset();
            const activeScenes = scene.scene.manager.getScenes(true);
            activeScenes.forEach(s => 
            {
                const key = s.scene.key;
                if (key !== "GameManager" && key !== "Settings") 
                {
                    scene.scene.stop(key);
                }
            });

            scene.scene.launch("Level1Game");
            scene.scene.launch("HUD");
            scene.scene.launch("Crosshair");

            scene.scene.sendToBack("Level1Game");
            scene.scene.bringToTop("Settings");
            scene.scene.bringToTop("Crosshair");
        }
        
        class Wheat
        {
            constructor(scene, worldWidthX)
            {    
                this.maxFrames = 2;        
                this.width = worldWidthX;
                this.scene = scene;
                this.direction = 1;
                this.currentFrameIndex = 0;
                this.delay = 300;
                this.timeAlive = 0;
                this.create();
                this.scene.events.on("update", this.update, this);
                this.scene.events.once("shutdown", () => 
                {
                    this.scene.events.off("update", this.update, this);
                });
            }

            create() 
            {
                this.scene.wheat = this.scene.add.tileSprite(0, this.scene.sys.game.config.height - 16, this.width, 16, "wheat", this.currentFrameIndex).setOrigin(0, 1).setScrollFactor(0.575);
            }

            update(time, delta) 
            {
                this.timeAlive += delta;
                
                if(this.timeAlive >= this.delay)
                {
                    while(this.timeAlive >= this.delay) 
                    {
                        this.timeAlive -= this.delay;
                    }
                    
                    let currentFrame = this.currentFrameIndex;

                    if(currentFrame === this.maxFrames - 1 && this.direction === 1) 
                    { 
                        this.direction = -1; 
                    } 
                    else if (currentFrame === 0 && this.direction === -1) 
                    {
                        this.direction = 1;  
                    }

                    let nextFrameIndex = currentFrame + this.direction;

                    this.scene.wheat.setFrame(nextFrameIndex);
                    this.currentFrameIndex = nextFrameIndex; 
                    this.scene.wheat.tilePositionX += 16; 

                    if(this.scene.wheat.tilePositionX >= 16 * this.maxFrames)
                    {
                        this.scene.wheat.tilePositionX = 0;
                    }
                }
            }
        }
        
        class Ground
        {
            constructor(scene, worldWidthX)
            {
                this.maxFrames = 2;        
                this.width = worldWidthX;
                this.scene = scene;
                this.direction = 1;
                this.currentFrameIndex = 0;
                this.delay = 300;
                this.timeAlive = 0;
                this.create();
                this.scene.events.on("update", this.update, this);
                this.scene.events.once("shutdown", () => 
                {
                    this.scene.events.off("update", this.update, this);
                });
            }

            create() 
            {
                this.scene.groundBotom = this.scene.add.tileSprite(0, this.scene.sys.game.config.height + 16, this.width * 2, 32, "ground").setOrigin(0, 1).setDepth(999999999);
                this.scene.physics.add.existing(this.scene.groundBotom);
                
                if(this.scene.groundBotom.body) 
                {
                    this.scene.groundBotom.body.setImmovable(true);
                    this.scene.groundBotom.body.allowGravity = false;
                }

                this.scene.grassTop = this.scene.add.tileSprite(0, this.scene.sys.game.config.height - 16, this.width, 16, "grasstop", this.currentFrameIndex);
                this.scene.grassTop.setOrigin(0, 1).setDepth(999999999);

                if(this.scene.player)
                {
                    this.scene.physics.add.collider(this.scene.player, this.scene.groundBotom);
                }
                if(this.scene.cults)
                {
                    this.scene.physics.add.collider(this.scene.cults, this.scene.groundBotom);
                }
                if(this.scene.cultKnifes)
                {
                    this.scene.physics.add.collider(this.scene.cultKnifes, this.scene.groundBotom);
                }
            }

            update(time, delta) 
            {
                this.timeAlive += delta;
                
                if(this.timeAlive >= this.delay)
                {
                    while(this.timeAlive >= this.delay) 
                    {
                        this.timeAlive -= this.delay;
                    }
                    
                    let currentFrame = this.currentFrameIndex;

                    if(currentFrame === this.maxFrames - 1 && this.direction === 1) 
                    { 
                        this.direction = -1; 
                    } 
                    else if(currentFrame === 0 && this.direction === -1) 
                    {
                        this.direction = 1;  
                    }

                    let nextFrameIndex = currentFrame + this.direction;

                    this.scene.grassTop.setFrame(nextFrameIndex);
                    
                    this.currentFrameIndex = nextFrameIndex; 
                    
                    this.scene.grassTop.tilePositionX += 32; 
                    
                    if(this.scene.grassTop.tilePositionX >= 32 * this.maxFrames)
                    {
                        this.scene.grassTop.tilePositionX = 0;
                    }
                }
            }
        }
        
        class Sky
        {
            constructor(scene, worldWidthX, texture)
            { 
                this.width = worldWidthX;
                this.scene = scene;
                this.delay = 300;
                this.scrollAmount = 1;
                this.timeAlive = 0;
                this.texture = texture;
                this.create();
                this.scene.events.on("update", this.update, this);
                this.scene.events.once("shutdown", () => 
                {
                    this.scene.events.off("update", this.update, this);
                });
            }

            create() 
            {
                this.scene.sky = this.scene.add.tileSprite(0, -32, this.width, this.scene.sys.game.config.height + 32, this.texture).setOrigin(0, 0);
                this.scene.sky.setScrollFactor(0.1);
            }

            update(time, delta) 
            {
                this.timeAlive += delta;
                
                if(this.timeAlive >= this.delay)
                {
                    while(this.timeAlive >= this.delay) 
                    {
                        this.timeAlive -= this.delay;
                    }
                    
                    this.scene.sky.tilePositionX += this.scrollAmount;
                }
            }
        }
    
        class MainMenu extends Phaser.Scene
        {
            constructor()
            {
              super({key: "MainMenu"});
            }

            preload()
            {

            }

            create ()
            {
                //START BASIC SETUP MainMenu


                this.input.setDefaultCursor("");
                const worldWidthX = this.sys.game.config.width * 3;
                this.physics.world.setBounds(0, 0, (worldWidthX / 3) - 120, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get("GameManager");
                this.HUD = this.scene.get("HUD");
                this.sound.pauseOnBlur = false;
                this.keyNameLookup = Object.fromEntries(Object.entries(Phaser.Input.Keyboard.KeyCodes).map(([name, code]) => [code, name]));
                this.settings = this.scene.get("Settings");
                

                //END BASIC SETUP MainMenu


                //START PROPS BEFORE PLAYER MainMenu

                
                this.newSky = new Sky(this, worldWidthX, "sky");

                this.stars = this.add.tileSprite(0, 0, worldWidthX, this.sys.game.config.height, "stars").setOrigin(0, 0);
                this.stars.setScrollFactor(0.1);

                this.barn = this.add.image
                (
                    (worldWidthX / 3) / 30,
                    this.sys.game.config.height - 16,
                    "barn"
                ).setOrigin(0, 1);
                this.barn.setScrollFactor(0.25);

                this.silo = this.add.image
                (
                    this.barn.width + (worldWidthX / 3) / 30,
                    this.sys.game.config.height - 16,
                    "silo"
                );
                this.silo.setOrigin(0, 1);
                this.silo.setScrollFactor(0.225);

                this.cross = this.add.image
                (
                    (worldWidthX / 3) + ((worldWidthX / 3) / 30),
                    this.sys.game.config.height - 16,
                    "cross"
                );
                this.cross.setOrigin(0, 1);
                this.cross.setScrollFactor(0.2);
                
                this.newWheat = new Wheat(this, worldWidthX);
                
                this.fence = this.add.tileSprite
                (
                    this.sys.game.config.width * (2/4) - 2,
                    this.sys.game.config.height - 16,
                    worldWidthX / 2 * (3 / 4) + 2,
                    16,
                    "fence"
                );
                this.fence.setScrollFactor(0.75);
                this.fence.setOrigin(0.5, 1);


                //END PROPS BEFORE PLAYER MainMenu


                //START PLAYER SETUP MainMenu


                createPlayer(this, Math.min(this.sys.game.config.width / 4, this.sys.game.config.width / 2), this.sys.game.config.height - 24, this.gameManager);
                this.player.buddha();


                //END PLAYER SETUP MainMenu


                //START ENEMY SETUP MainMenu


                //END ENEMY SETUP MainMenu


                //START PROPS AFTER PLAYER MainMenu


                this.copcar = this.add.image
                (
                    worldWidthX / 4 + this.sys.game.config.width / 4 - this.sys.game.config.width / 8,
                    this.sys.game.config.height - 16,
                    "copcar"
                ).setOrigin(1, 1);

                this.pipe = this.physics.add.sprite(worldWidthX / 2 + this.sys.game.config.width / 4 - 6, this.sys.game.config.height - 16, "pipe");
                this.pipe.setOrigin(0, 1);
                this.pipe.body.allowGravity = false;
                this.pipe.body.setImmovable(true);

                if(!this.anims.get("stabAnim"))
                {
                    this.anims.create
                    ({
                        key: "stabAnim",
                        frames: this.anims.generateFrameNumbers("stab", {start: 0, end: 2 }),
                        frameRate: 2,
                        repeat: 0
                    });
                }
                this.stab = this.add.sprite(this.pipe.x + 1, this.pipe.y, "stab").setOrigin(0, 1);
                this.stab.setActive(false);
                this.stab.setVisible(false);

                this.physics.add.collider(this.pipe, this.player, (pipe, player) =>
                {
                    player.destroy();
                    this.stab.setActive(true);
                    this.stab.setVisible(true);
                    this.sound.play("powerup");

                    this.stab.on(Phaser.Animations.Events.ANIMATION_UPDATE, (anim, frame) => 
                    {
                        if(frame.index === 2) 
                        {
                            this.sound.play("stab");
                            this.destroyedControlsForGood = true;
                            this.destroyControls();
                        }
                    });

                    this.stab.play("stabAnim", true);
                });

                this.stab.on(Phaser.Animations.Events.ANIMATION_COMPLETE, () => 
                {
                    this.cameras.main.pan(worldWidthX, this.sys.game.config.height / 2, 2000, "Sine.easeInOut");
                });
                
                this.ground = new Ground(this, worldWidthX);

                this.logo = createText(this, worldWidthX / 6, this.sys.game.config.height / 2, "House Call", 20, "#fff").setOrigin(0.5, 0.5);
                this.logo.setInteractive({cursor: "pointer"});

                this.physics.add.existing(this.logo, true);
                this.physics.add.collider(this.logo, this.playerBulletsHolder, (logo, bullet) =>
                {
                    bullet.destroy();
                    logo.destroy();
                    this.quickStart.destroy();
                    this.cameras.main.pan(worldWidthX / 2, this.sys.game.config.height / 2, 2000, "Sine.easeInOut");

                    this.time.delayedCall(2000, () =>
                    {
                        this.player.x = worldWidthX / 3 - this.player.width / 2;
                        this.player.canMove = false;
                        this.tweens.add
                        ({
                            targets: this.player, 
                            x: worldWidthX / 3 + this.player.width / 2,               
                            y: this.sys.game.config.height - 24,               
                            duration: 250,       
                            ease: "linear",       
                            onComplete: () => 
                            {
                                this.physics.world.setBounds(this.sys.game.config.width, 0, this.sys.game.config.width, 176);
                                this.player.canMove = true;
                            }
                        });
                    }, [], this);

                });
                
                this.displayControls();
                
                this.quickStart = createText(this, this.game.config.width - (this.game.config.width / 2), 5, "QUICK START", 10, "#ffffff").setOrigin(0.5, 0).setDepth(1232300);
                this.quickStart.setInteractive({cursor: "pointer"});
                this.quickStart.on("pointerdown", () =>
                {
                    if(this.settings.displayedSettings === false)
                    {
                        this.scene.stop("MainMenu");
                        this.scene.stop("HUD");
                        event.stopPropagation();
                        this.scene.start("Level1Game");
                        this.scene.launch("HUD");
                    }
                });
               
                this.highScore = createText(this, this.game.config.width * 3 - (this.game.config.width / 2), 5, "High Score: " + this.gameManager.experimentalHighScore, 10, "#ffffff").setOrigin(0.5, 0).setDepth(1232300);
                
                this.start = createText(this, worldWidthX - this.sys.game.config.width / 2, this.sys.game.config.height / 2, "Start", 20, "#fff").setOrigin(0.5, 0.5);
                this.start.setInteractive({cursor: "pointer"});
                this.start.on("pointerdown", () =>
                {
                    if(this.settings.displayedSettings === false)
                    {
                        this.scene.stop("MainMenu");
                        this.scene.stop("HUD");
                        event.stopPropagation();
                        this.scene.start("Level1Game");
                        this.scene.launch("HUD");
                    }
                });


                //END PROPS AFTER PLAYER MainMenu


                //START CAMERA SETUP MainMenu


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;
                this.cameras.main.setZoom(1);


                //END CAMERA SETUP MainMenu
            }
            
            refreshControls()
            {
                if(!this.destroyedControlsForGood)
                {
                    this.destroyControls();
                    this.displayControls();
                }
            }
            
            
            displayControls()
            {
                this.controls = createText(this, 1200 / 2, 5, "Controls:", 20, "#fff");
                this.strafeControls = createText(this, 1200 / 2, 0 + this.controls.height + 10, this.getActionAssignment("walkLeft") + "/" + this.getActionAssignment("walkRight") + ": Walk", 12, "#fff");
                this.jumpControls = createText(this, 1200 / 2, 0 + this.controls.height + this.strafeControls.height + 13, this.getActionAssignment("jump") + ": Jump", 12, "#fff");
                this.rightClickControls = createText(this, 1200 / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + 16, this.getActionAssignment("block") + ": Block", 12, "#fff");
                this.leftClickControls = createText(this, 1200 / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + this.rightClickControls.height + 19, this.getActionAssignment("useShotgun") + ": Use Shotgun (Hold)", 12, "#fff");
                this.pistolControls = createText(this, 1200 / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + this.rightClickControls.height + this.leftClickControls.height + 22, this.getActionAssignment("usePistol") + ": Use Pistol", 12, "#fff");
                this.settingsControls = createText(this, 1200 / 2, 0 + this.controls.height + this.strafeControls.height + this.jumpControls.height + this.rightClickControls.height + this.leftClickControls.height + this.pistolControls.height +  25, "Esc: Open Settings", 12, "#fff");
            }
            
            destroyControls()
            {
                this.controls.destroy();
                this.strafeControls.destroy();
                this.jumpControls.destroy();
                this.rightClickControls.destroy();
                this.leftClickControls.destroy();
                this.pistolControls.destroy();
                this.settingsControls.destroy();
            }
            
            getActionAssignment(actionName)
            {
                let currentAction = this.gameManager.actions[actionName];
                
                if(currentAction.type === "KEY") 
                {
                    let name = this.keyNameLookup[currentAction.code];
                    try
                    {
                        return name.split("_").map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join("-");
                    }
                    catch(e)
                    {
                        return name;
                    }
                } 
                else 
                {
                    if(currentAction.button === 0)
                    {
                        return "Left-Mouse";
                    }
                    else if(currentAction.button === 1)
                    {
                        return "Middle-Mouse";
                    }
                    else if(currentAction.button === 2)
                    {
                        return "Right-Mouse";
                    }
                    else
                    {
                        return "undefined";
                    }
                }
            }
            
            update(time, delta)
            {
                if(this.player.health < 1000)
                {
                    this.player.buddha();
                }
                
                if(this.settings.displayedSettings === true)
                {
                    if(this.input.enabled) 
                    {
                        this.input.enabled = false;
                        this.input.setDefaultCursor("default");
                    }
                }
                else
                {
                    if(!this.input.enabled) 
                    { 
                        this.input.enabled = true;
                        this.input.setDefaultCursor("default");
                    }
                }
            }
        }
  
        function createText(scene, x, y, words, size, color)
        {
            let newText = scene.add.text(x, y, words, { fontFamily: "hcfont", fontSize: size, fill: color}).setOrigin(0.5, 0);
            return newText;
        }
  
        function makeRain(scene, texture)
        {
            scene.rain = scene.add.particles
            (
                0, 0, 
                texture,
                {
                    x: { min: 0, max: scene.sys.game.config.width + (scene.sys.game.config.width / 5) },
                    y: { min: -15, max:-7 },
                    angle: { min: 90, max: 180 }, 
                    speed: { min: 100, max: 300 },
                    gravityY: 100,
                    lifespan: { min: 1500, max: 1500 },
                    quantity: 15,
                    scale: { start: 0.35, end: 0.25 },
                    alpha: { start: 1, end: 0 },
                    blendMode: "NORMAL",
                    frequency: 50
                }
            );

            scene.rain.start();
            scene.rain.setScrollFactor(0);
        }
  
        function filterColors(scene, color)
        {
            const itemsToTint = 
            [
                "shed", "fence", "couch", "grill", "groundBotom", "grassTop", "wheat", "cross", "barn", "silo", "tractor", "copcar"
            ];

            itemsToTint.forEach(propKey => 
            {
                const asset = scene[propKey];
                
                if(asset) 
                {
                    asset.setTint(color);     
                }
            });
        }
  
        function createRandomEnemies(scene, spawnList, worldWidthX, gameManager)
        {
            function getRandomCoords(worldWidthX) 
            {
                let min = 600;
                return Math.floor(Math.random() * (worldWidthX - min + 1)) + min;
            }

            function positionTaken(xCoord, chosenPositions, range)
            {
                for(const position of chosenPositions) 
                {
                    if(Math.abs(position - xCoord) <= range) 
                    {
                        return true;
                    }
                }

                return false;
            }

            const enemyData = new Map();

            for (const enemy of spawnList) 
            {
                const currentEnemy = enemy.type;
                const enemyAmount = enemy.amount;

                let positions = new Array();

                if(currentEnemy === "cult")
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 8;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newCult = { x: xCoord, y: 100 };
                        chosenPositions.add(xCoord);
                        positions.push(newCult);
                    }

                    enemyData.set("cult", { positions: positions });
                    cultCreator(scene, positions, gameManager);
                }    
                else if(currentEnemy === "cultKnife")
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 8;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newCultKnife = { x: xCoord, y: 100 };
                        chosenPositions.add(xCoord);
                        positions.push(newCultKnife);
                    }

                    enemyData.set("cultKnife", { positions: positions });
                    cultKnifeCreator(scene, positions, gameManager);
                }
                else if(currentEnemy === "eye")
                {
                    const chosenPositions = new Set();

                    for(let i = 0; i < enemyAmount; i++)
                    {
                        let range = 16;
                        let xCoord;

                        do
                        {
                            xCoord = getRandomCoords(worldWidthX);
                        }
                        while(positionTaken(xCoord, chosenPositions, range));

                        const newEye = { x: xCoord, y: 88 };
                        chosenPositions.add(xCoord);
                        positions.push(newEye);
                    }

                    enemyData.set("eye", { positions: positions });
                    eyeCreator(scene, positions, gameManager);
                }
            }

            return enemyData;
        }

        function getRandomXAnywhere(worldWidthX)
        {
            return (Math.floor(Math.random() * (worldWidthX - 0 + 1)) + 0);
        }

        function getRandMinMax(min, max)
        {
            return (Math.floor(Math.random() * (max - min + 1)) + min);
        }
        
        function makeLevelPropsRandomAfterWheat(scene, propData, worldWidthX)
        {
            if(!propData)
            {
                propData = 
                {
                    "fence":
                    {
                        name: "fence",
                        pos:  getRandomXAnywhere(worldWidthX * 0.75),
                        scrollFactor: 0.75,
                        display: getRandMinMax(1, 100) === 1 ? true : false,
                        tileSprite: true,
                        width:  (Math.floor(getRandMinMax(0, worldWidthX * 0.75 / 2) / 4) * 4) + 3,
                        positionOffset: -3
                    },
                    "couch":
                    {
                        name: "couch",
                        pos:  getRandomXAnywhere(worldWidthX * 0.775),
                        scrollFactor: 0.775,
                        flip: false,
                        display: getRandMinMax(1, 1000) === 1 ? true : false
                    },
                    "grill":
                    {
                        name: "grill",
                        pos:  getRandomXAnywhere(worldWidthX * 0.8),
                        scrollFactor: 0.8,
                        flip: false,
                        display: getRandMinMax(1, 1000) === 1 ? true : false
                    },
                    "copcar":
                    {
                        name: "copcar",
                        pos:  getRandomXAnywhere(worldWidthX * 1),
                        scrollFactor: 1,
                        flip: getRandMinMax(1, 10) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    }
                };
            }
            
            Object.entries(propData).forEach(([name, definition]) => 
            {
                if(definition.display)
                {
                    if(definition.tileSprite)
                    {
                        let offsetX = definition.positionOffset || 0;
                        scene[name] = scene.add.tileSprite(definition.pos, 176 - 16, definition.width, 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor);
                        scene[name].tilePositionX = offsetX;
                    }
                    else
                    {
                        scene[name] = scene.add.image(definition.pos, scene.sys.game.config.height - 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor).setFlipX(definition.flip);
                    }
                }
            });
            
            return propData;
        }
        
        function makeLevelPropsRandomBeforeWheat(scene, propData, worldWidthX)
        {
            if(!propData)
            {
                propData = 
                {
                    "silo":
                    {
                        name: "silo",
                        pos:  getRandomXAnywhere(worldWidthX * 0.17),
                        scrollFactor: 0.17,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "barn":
                    {
                        name: "barn",
                        pos:  getRandomXAnywhere(worldWidthX *  0.2),
                        scrollFactor: 0.2,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "cross":
                    {
                        name: "cross",
                        pos:  getRandomXAnywhere(worldWidthX * 0.25),
                        scrollFactor: 0.25,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "shed":
                    {
                        name: "shed",
                        pos:  getRandomXAnywhere(worldWidthX * 0.325),
                        scrollFactor: 0.325,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "scarecrow":
                    {
                        name: "scarecrow",
                        pos:  getRandomXAnywhere(worldWidthX * 0.4),
                        scrollFactor: 0.4,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    },
                    "tractor":
                    {
                        name: "tractor",
                        pos:  getRandomXAnywhere(worldWidthX * 0.45),
                        scrollFactor: 0.45,
                        flip: getRandMinMax(1, 2) === 1 ? true : false,
                        display: getRandMinMax(1, 100) === 1 ? true : false
                    }
                };
            }
            
            Object.entries(propData).forEach(([name, definition]) => 
            {
                if(definition.display)
                {
                    scene[name] = scene.add.image(definition.pos, scene.sys.game.config.height - 16, definition.name).setOrigin(0.5, 1).setScrollFactor(definition.scrollFactor).setFlipX(definition.flip);
                }
            });
            
            return propData;
        }
    
        class Level1Game extends Phaser.Scene
        {
            constructor()
            {
                super({ key: "Level1Game" });
            }

            preload()
            {

            }

            create()
            {
                //START BASIC SETUP Level1Game


                this.input.setDefaultCursor("");
                const worldWidthX = 1800;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get("GameManager");
                this.HUD = this.scene.get("HUD");
                this.gameManager.updateHighestLevel(1);
                this.gameManager.updateCurrentLevel(1);
                this.sound.pauseOnBlur = false;
                
                if(this.gameManager.cheats === true && this.gameManager.alwaysBlock === false)
                {
                    this.gameManager.cheats = false;
                }

                //END BASIC SETUP Level1Game


                //START PROPS BEFORE PLAYER Level1Game


                this.newSky = new Sky(this, worldWidthX, "sky");

                this.stars = this.add.tileSprite(0, 0, worldWidthX, this.sys.game.config.height, "stars").setOrigin(0, 0);
                this.stars.setScrollFactor(0.1);
                
                this.gameManager.level1BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level1BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level1AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level1AfterPropData, worldWidthX);


                //END PROPS BEFORE PLAYER Level1Game


                //START PLAYER SETUP Level1Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level1Game


                //START ENEMY SETUP Level1Game


                if(this.gameManager.level1Data === null)
                { 
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(2, 3) },
                                { type: "cultKnife", amount: getRandMinMax(4, 5) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(2, 3) },
                                { type: "cultKnife", amount: getRandMinMax(3, 5) }                            
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(2, 2) },
                                { type: "cultKnife", amount: getRandMinMax(4, 6) }
                            ];
                            break;
                    }

                    this.gameManager.level1Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                {
                    for(const enemy of this.gameManager.level1Data.keys()) 
                    {
                        if(enemy === "cult")
                        {
                            let enemyData = this.gameManager.level1Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "cultKnife")
                        {
                            let enemyData = this.gameManager.level1Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level1Game


                //START PROPS AFTER PLAYER Level1Game


                const thisLevel = 1;
                this.pipe = new pipeNext(this, 1594, this.sys.game.config.height - 16, "Level2Game", thisLevel, this.gameManager);

                this.ground = new Ground(this, worldWidthX);


                //END PROPS AFTER PLAYER Level1Game


                //START CAMERA SETUP Level1Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level1Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop("Level1Game");
                    this.scene.stop("HUD");
                    this.scene.start("Level1Game");
                    this.scene.launch("HUD");
                }

                cultSeparation(this.cults, this.player);
            }
        }

        class Level2Game extends Phaser.Scene
        {
            constructor()
            {
                super({ key: "Level2Game" });
            }

            preload()
            {

            }

            create()
            {
                //START BASIC SETUP Level2Game


                this.input.setDefaultCursor("");
                const worldWidthX = 2250;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get("GameManager");
                this.HUD = this.scene.get("HUD");
                this.gameManager.updateHighestLevel(2);
                this.gameManager.updateCurrentLevel(2);
                this.sound.pauseOnBlur = false;


                //END BASIC SETUP Level2Game


                //START PROPS BEFORE PLAYER Level2Game


                this.newSky = new Sky(this, worldWidthX, "sky");
                this.sky.postFX.addColorMatrix().grayscale(1);   
                        
                this.gameManager.level2BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level2BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level2AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level2AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, "pipe");       
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level2Game


                //START PLAYER SETUP Level2Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level2Game


                //START ENEMY SETUP Level2Game


                if(this.gameManager.level2Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(8, 12) },
                                { type: "cultKnife", amount: getRandMinMax(1, 1) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(10, 13) },
                                { type: "cultKnife", amount: getRandMinMax(1, 2) }
                            ];
                            break;
                            
                        case 3:
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(8, 15) },
                                { type: "cultKnife", amount: getRandMinMax(1, 2) }
                            ];
                            break;
                    }
                    

                    this.gameManager.level2Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level2Data.keys()) 
                    {
                        if(enemy === "cult")
                        {
                            let enemyData = this.gameManager.level2Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "cultKnife")
                        {
                            let enemyData = this.gameManager.level2Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level2Game


                //START PROPS AFTER PLAYER Level2Game


                const thisLevel = 2;
                this.pipe = new pipeNext(this, 2044, this.sys.game.config.height - 16, "Level3Game", 2, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                makeRain(this, "raindrop");

                filterColors(this, 0xd1e0e0);


                //END PROPS AFTER PLAYER Level2Game


                //START CAMERA SETUP Level2Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level2Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop("Level2Game");
                    this.scene.stop("HUD");
                    this.scene.start("Level1Game");
                    this.scene.launch("HUD");
                }

                cultSeparation(this.cults, this.player);
            }
        }

        class Level3Game extends Phaser.Scene
        {
            constructor()
            {
              super({key: "Level3Game"});
            }

            create()
            {
                //START BASIC SETUP Level3Game


                this.input.setDefaultCursor("");
                const worldWidthX = 1325;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get("GameManager");
                this.HUD = this.scene.get("HUD");
                this.gameManager.updateHighestLevel(3);
                this.gameManager.updateCurrentLevel(3);
                this.sound.pauseOnBlur = false;


                //END BASIC SETUP Level3Game


                //START PROPS BEFORE PLAYER Level3Game


                this.newSky = new Sky(this, worldWidthX, "redskyrain");
                                    
                this.gameManager.level3BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level3BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level3AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level3AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, "pipe");
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level3Game


                //START PLAYER SETUP Level3Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);
                //this.player.buddha();


                //END PLAYER SETUP Level3Game


                //START ENEMY SETUP Level3Game


                if(this.gameManager.level3Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(2, 4) },
                                { type: "cultKnife", amount: getRandMinMax(6, 8) },
                                { type: "eye", amount: getRandMinMax(2, 4) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(2, 4) },
                                { type: "cultKnife", amount: getRandMinMax(2, 4) },
                                { type: "eye", amount: getRandMinMax(6, 8) }
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(6, 8) },
                                { type: "cultKnife", amount: getRandMinMax(2, 4) },
                                { type: "eye", amount: getRandMinMax(2, 4) }
                            ];
                            break;
                    }

                    this.gameManager.level3Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level3Data.keys()) 
                    {
                        if(enemy === "cult")
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "cultKnife")
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "eye")
                        {
                            let enemyData = this.gameManager.level3Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            eyeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level3Game


                //START PROPS AFTER PLAYER Level3Game


                const thisLevel = 3;
                this.pipe = new pipeNext(this, 1119, this.sys.game.config.height - 16, "Level4Game", thisLevel, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                makeRain(this, "bloodrain");

                filterColors(this, 0xffcccc);


                //END PROPS AFTER PLAYER Level3Game


                //START CAMERA SETUP Level3Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level3Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop("Level3Game");
                    this.scene.stop("HUD");
                    this.scene.start("Level2Game");
                    this.scene.launch("HUD");
                }

                cultSeparation(this.cults, this.player);
                eyeSeparation(this.eyes, this.player);
                
                this.sky.tilePositionX += 0.01;
            }
        }
  
        class Level4Game extends Phaser.Scene
        {
            constructor()
            {
              super({key: "Level4Game"});
            }

            create()
            {
                //START BASIC SETUP Level4Game


                this.input.setDefaultCursor("");
                const worldWidthX = 2400;
                this.physics.world.setBounds(0, 0, worldWidthX, 176);
                this.cursors = this.input.keyboard.createCursorKeys();
                this.gameManager = this.scene.get("GameManager");
                this.HUD = this.scene.get("HUD");
                this.gameManager.updateHighestLevel(4);
                this.gameManager.updateCurrentLevel(4);
                this.sound.pauseOnBlur = false;


                //END BASIC SETUP Level4Game


                //START PROPS BEFORE PLAYER Level4Game


                this.newSky = new Sky(this, worldWidthX, "redsky");
                                                
                this.gameManager.level4BeforePropData = makeLevelPropsRandomBeforeWheat(this, this.gameManager.level4BeforePropData, worldWidthX);

                this.newWheat = new Wheat(this, worldWidthX);
                
                this.gameManager.level4AfterPropData = makeLevelPropsRandomAfterWheat(this, this.gameManager.level4AfterPropData, worldWidthX);

                this.pipe = this.add.image(15, this.sys.game.config.height - 16, "pipe");
                this.pipe.setOrigin(0, 1);


                //END PROPS BEFORE PLAYER Level4Game


                //START PLAYER SETUP Level4Game


                createPlayer(this, 100, this.sys.game.config.height - 24, this.gameManager);


                //END PLAYER SETUP Level4Game


                //START ENEMY SETUP Level4Game


                if(this.gameManager.level4Data === null)
                {
                    let randomListToGenerate = getRandMinMax(1, 3);
                    
                    switch(randomListToGenerate)
                    {
                        case 1:
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(19, 21) },
                                { type: "cultKnife", amount: getRandMinMax(4, 5) },
                                { type: "eye", amount: getRandMinMax(6, 8) }
                            ];
                            break;
                            
                        case 2: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(17, 19) },
                                { type: "cultKnife", amount: getRandMinMax(2, 4) },
                                { type: "eye", amount: getRandMinMax(8, 10) }
                            ]; 
                            break;
                            
                        case 3: 
                            this.spawnList = 
                            [
                                { type: "cult", amount: getRandMinMax(19, 21) },
                                { type: "cultKnife", amount: getRandMinMax(1, 1) },
                                { type: "eye", amount: getRandMinMax(6, 8) }
                            ];
                            break;
                    }
                    
                    this.gameManager.level4Data = createRandomEnemies(this, this.spawnList, worldWidthX, this.gameManager);
                }
                else
                { 
                    for(const enemy of this.gameManager.level4Data.keys()) 
                    {
                        if(enemy === "cult")
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "cultKnife")
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            cultKnifeCreator(this, enemyPositionArray, this.gameManager);
                        }
                        else if(enemy === "eye")
                        {
                            let enemyData = this.gameManager.level4Data.get(enemy);
                            let enemyPositionArray = enemyData.positions;
                            eyeCreator(this, enemyPositionArray, this.gameManager);
                        }
                    }
                }


                //END ENEMY SETUP Level4Game


                //START PROPS AFTER PLAYER Level4Game


                const thisLevel = 4;
                this.pipe = new pipeNext(this, 2194, this.sys.game.config.height - 16, "MainMenu", 4, this.gameManager);

                this.ground = new Ground(this, worldWidthX);

                filterColors(this, 0xff9999);


                //END PROPS AFTER PLAYER Level4Game


                //START CAMERA SETUP Level4Game


                this.cameras.main.setBounds(0, 0, worldWidthX, 176);
                this.cameras.main.startFollow(this.player, true, 1, 1, -(this.sys.game.config.width / 4), (this.sys.game.config.height / 2));
                this.cameras.main.setZoom(1);
                this.cameras.scrollX = 0;
                this.cameras.scrollY = 0;


                //END CAMERA SETUP Level4Game
            }

            update(time, delta)
            {
                if(this.player.killed)
                {
                    this.scene.stop("Level4Game");
                    this.scene.stop("HUD");
                    this.scene.start("Level3Game");
                    this.scene.launch("HUD");
                }

                cultSeparation(this.cults, this.player);
                eyeSeparation(this.eyes, this.player);
            }
        }
  
        class UpgradeRoom extends Phaser.Scene
        {
            constructor()
            {
                super({key: "UpgradeRoom"});
                
                this.gameManager = game.scene.getScene("GameManager");
                
                this.cardAmount = Object.keys(this.gameManager.upgradeCardData).length;
                this.upgradeCardData = this.gameManager.upgradeCardData;
            }

            create()
            {
                this.settings = this.scene.get("Settings");
                this.input.setDefaultCursor("pointer");
                

                //START CARD SETUP


                let card1;
                let card2;

                do
                {
                    card1 = this.getRandomCardId();
                }
                while(this.gameManager.ownedCards.has(card1))

                do
                {
                    card2 = this.getRandomCardId();
                }
                while(card2 === card1 || this.gameManager.ownedCards.has(card2) || (this.gameManager.ammoUpgrades.has(card1) && this.gameManager.ammoUpgrades.has(card2)))

                this.cardDisplay1 = this.displayCard(card1, "left");
                this.cardDisplay1.on("pointerdown", () =>
                {
                    if(this.settings.displayedSettings === false)
                    {
                        this.acceptCard(card1);
                    }
                });

                this.cardDisplay2 = this.displayCard(card2, "right");
                this.cardDisplay2.on("pointerdown", () =>
                {
                    if(this.settings.displayedSettings === false)
                    {
                        this.acceptCard(card2);
                    }
                }); 


                //END CARD SETUP
            }

            update(time, delta)
            {
                if(this.settings.displayedSettings === true)
                {
                    if(this.input.enabled) 
                    {
                        this.input.enabled = false;
                        this.input.setDefaultCursor("default");
                    }
                }
                else
                {
                    if(!this.input.enabled) 
                    {
                        this.input.enabled = true;
                        this.input.setDefaultCursor("pointer");
                    }
                }
            }

            acceptCard(id)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                card.effect(this.gameManager);
                this.gameManager.ownedCards.add(id); 
                transitionLevels(this, this.gameManager);
            }

            getRandomCardId()
            {
                return Math.floor(Math.random() * (this.cardAmount - 1 + 1)) + 1;
            }

            displayCard(id, position)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                let titleText;
                let descriptionText;
                let icon;
                let xPos;
                const yCenter = this.sys.game.config.height / 2;

                if(position === "left")
                {
                    xPos = this.sys.game.config.width / 4;
                }
                else
                {
                    xPos = (this.sys.game.config.width / 4) * 3;
                }

                const cardContainer = this.add.container(xPos, yCenter);
                titleText = createText(this, 0, -50, card.name, 20, "#f00").setOrigin(0.5, 1);
                descriptionText = createText(this, 0, 50, card.description, 12, "#f00").setOrigin(0.5, 0);
                descriptionText.setStyle
                ({
                    wordWrap: { width: this.sys.game.config.width / 2 - 10, use:"true" }
                });

                if(card.icon)
                {
                    icon = this.add.image
                    (
                      xPos,
                      yCenter,
                      card.icon
                    ).setOrigin(0.5, 0.5);
                }

                cardContainer.add([titleText, descriptionText]);

                const hitAreaWidth = this.sys.game.config.width / 2;
                const hitAreaHeight = this.sys.game.config.height;

                const hitArea = new Phaser.Geom.Rectangle
                (
                    -hitAreaWidth / 2,
                    -hitAreaHeight / 2,
                    hitAreaWidth,
                    hitAreaHeight
                );

                cardContainer.setInteractive(hitArea, Phaser.Geom.Rectangle.Contains);

                return cardContainer;
            }
        }
  
        class GameManager extends Phaser.Scene
        {
            constructor()
            {
                super({ key: "GameManager" });
                
                this.upgradeCardData = 
                {
                    "birdshot": 
                    {
                        id: 1,
                        name: "Birdshot",
                        description: "Replace shells with birdshot.",
                        icon: "birdshoticon",
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = "birdshot";
                        }
                    },
                    "slugs": 
                    {
                        id: 2,
                        name: "Slugs",
                        description: "Replace shells with slugs.",
                        icon: "slugicon",
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = "slug";
                        }
                    },
                    "damage": 
                    {
                        id: 3,
                        name: "Gun Oil",
                        description: "Increase shotgun damage by 25%.",
                        icon: "damageicon",
                        effect: (gameManager) => 
                        {
                            gameManager.damageUpgrade = true;
                        }
                    }, 
                    "health": 
                    {
                        id: 4,
                        name: "Conditioning",
                        description: "Survive an extra hit.",
                        icon: "healthicon",
                        effect: (gameManager) => 
                        {
                            gameManager.healthUpgrade = true;
                        }
                    },
                    "doubleFire": 
                    {
                        id: 5,
                        name: "Veneration",
                        description: "Successful kills trigger double fire rate. Can't jump.",
                        icon: "cultenergyicon",
                        effect: (gameManager) => 
                        {
                            gameManager.doubleFireUpgrade = true;
                        }
                    },
                    "pistolDamage": 
                    {
                        id: 6,
                        name: "Hollow Points",
                        description: "Double handgun damage.",
                        icon: "hollowpointsicon",
                        effect: (gameManager) => 
                        {
                            gameManager.pistolUpgrade = true;
                        }
                    },
                    "multiAmmo": 
                    {
                        id: 7,
                        name: "Random Shells",
                        description: "Replace shells with random ones.",
                        icon: "multiammoicon",
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = true;
                        }
                    },
                    "triplepistol": 
                    {
                        id: 8,
                        name: "Panic",
                        description: "Fire three handgun rounds at once. High cooldown.",
                        icon: "triplepistolicon",
                        effect: (gameManager) => 
                        {
                            gameManager.triplePistolUpgrade = true;
                            gameManager.quintuplePistolUpgrade = false;
                        }
                    },
                    "quintuplepistol": 
                    {
                        id: 9,
                        name: "Terror",
                        description: "Fire five handgun rounds at once. Highest cooldown.",
                        icon: "quintuplepistolicon",
                        effect: (gameManager) => 
                        {
                            gameManager.triplePistolUpgrade = false;
                            gameManager.quintuplePistolUpgrade = true;
                        }
                    },
                    "mousepistol": 
                    {
                        id: 10,
                        name: "Center Mass",
                        description: "Handgun aims with mouse.",
                        icon: "mousepistolicon",
                        effect: (gameManager) => 
                        {
                            gameManager.mousePistolUpgrade = true;
                        }
                    },
                    "numfourbuckshot": 
                    {
                        id: 11,
                        name: "#4 Buckshot",
                        description: "Replace shells with #4 buckshot.",
                        icon: "numfourbuckshoticon",
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = "numfourbuckshot";
                        }
                    },
                    "000buckshot": 
                    {
                        id: 12,
                        name: "000 Buckshot",
                        description: "Replace shells with 000 buckshot.",
                        icon: "000buckshoticon",
                        effect: (gameManager) => 
                        {
                            this.clearAmmoOwned();
                            gameManager.multiAmmoUpgrade = false;
                            gameManager.fireModeUpgrade = "000buckshot";
                        }
                    },
                    "highvelocity": 
                    {
                        id: 13,
                        name: "High Velocity",
                        description: "Shotgun projectiles penetrate an extra enemy.",
                        icon: "shieldicon",
                        effect: (gameManager) => 
                        {
                            gameManager.highVelocityUpgrade = true;
                        }
                    }
                };

                this.ammoUpgrades = new Set([1, 2, 7, 11, 12]);

                this.highestLevel = 0;
                this.initialHighestLevel = this.highestLevel;
                this.currentLevel = 0;
                this.visitedUpgradeRoom1 = false;
                this.visitedUpgradeRoom2 = false;
                this.visitedUpgradeRoom3 = false;
                this.score = 0;
                this.highScore = 0;
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCHighScore")) !== null)
                    {
                        this.highScore = parseInt(localStorage.getItem("HCHighScore"));
                    }
                }
                
                this.experimentalHighScore = 0;
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCExperimentalHighScore")) !== null)
                    {
                        this.experimentalHighScore = parseInt(localStorage.getItem("HCExperimentalHighScore"));
                    }
                }
                
                this.easyHighScore = 0;
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCEasyHighScore")) !== null)
                    {
                        this.easyHighScore = parseInt(localStorage.getItem("HCEasyHighScore"));
                    }
                }

                this.ownedCards = new Set();

                this.fireModeUpgrade = "buckshot";
                this.damageUpgrade = false;
                this.blockUpgrade = false;
                this.healthUpgrade = false;
                this.doubleFireUpgrade = false;
                this.pistolUpgrade = false;
                this.multiAmmoUpgrade = false;
                this.triplePistolUpgrade = false;
                this.quintuplePistolUpgrade = false;
                this.mousePistolUpgrade = false;
                this.highVelocityUpgrade = false;
                
                this.gameMode = "Standard";
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCGameMode")) !== null)
                    {
                        this.gameMode = localStorage.getItem("HCGameMode");
                    }
                }  

                this.level1Data = null;
                this.level2Data = null;
                this.level3Data = null;
                this.level4Data = null;
                
                this.level1BeforePropData = null;
                this.level2BeforePropData = null;
                this.level3BeforePropData = null;
                this.level4BeforePropData = null;
                
                this.level1AfterPropData = null;
                this.level2AfterPropData = null;
                this.level3AfterPropData = null;
                this.level4AfterPropData = null;
                
                this.alwaysBuddha = false;
                this.alwaysBlock = false;

                this.HUDSetting = "Score-Only";
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCHUDSetting")) !== null)
                    {
                        this.HUDSetting = localStorage.getItem("HCHUDSetting");
                    }
                }

                this.screenShake = true;
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCScreenShakeSetting")) !== null)
                    {
                        this.screenShake = JSON.parse(localStorage.getItem("HCScreenShakeSetting"));
                    }
                }
                
                this.updateGameMode();
            }
            
            resetActions()
            {
                localStorage.removeItem("HCGameControls");
                this.actions = JSON.parse(JSON.stringify(this.defaultActions));
                this.refreshControls();
                game.scene.getScene("Settings").refresh();
                
                if(this.scene.isActive(game.scene.getScene("MainMenu")))
                {
                    game.scene.getScene("MainMenu").refreshControls();
                }
                
                this.input.keyboard.off("keydown");
                this.input.off("pointerdown");
                game.scene.getScene("Settings").remapping = false;
            }
            
            resetMappingInProgress()
            {
                
                if(this.scene.isActive(game.scene.getScene("MainMenu")))
                {
                    game.scene.getScene("MainMenu").refreshControls();
                }
                
                this.input.keyboard.off("keydown");
                this.input.off("pointerdown");
                game.scene.getScene("Settings").remapping = false;
            }

            create()
            {
                this.defaultActions =
                {
                    useShotgun: { type: "MOUSE", button: 0 },
                    jump: { type: "KEY", code: 32 },
                    walkLeft: { type: "KEY", code: 65 },
                    walkRight: { type: "KEY", code: 68 },
                    usePistol: { type: "KEY", code: 69 },
                    block: { type: "MOUSE", button: 2 }
                };
                
                this.actions = JSON.parse(JSON.stringify(this.defaultActions));
                
                if(checkStorage() === true)
                {
                    if((localStorage.getItem("HCGameControls")) !== null)
                    {
                        this.actions = JSON.parse(localStorage.getItem("HCGameControls"));
                    }
                }
                
                this.refreshControls(); 
            }
            
            refreshControls() 
            {
                if(this.keys) 
                {
                    for(let action in this.keys) 
                    {
                        this.input.keyboard.removeKey(this.keys[action]);
                    }
                }

                this.keys = {};

                for(let action in this.actions) 
                {
                    if(this.actions[action].type === "KEY") 
                    {
                        this.keys[action] = this.input.keyboard.addKey(this.actions[action].code);
                    }
                }
            }
            
            remapAction(actionName) 
            {
                game.scene.getScene("Settings").remapping = true;
                
                this.input.keyboard.once("keydown", (event) => 
                {
                    this.input.off("pointerdown");
                    game.scene.getScene("Settings").remapping = false;
                    
                    if(event.keyCode !== Phaser.Input.Keyboard.KeyCodes.ESC)
                    {
                        this.updateBinding(actionName, "KEY", event.keyCode);
                        game.scene.getScene("Settings").refresh();
                        
                        if(this.scene.isActive(game.scene.getScene("MainMenu")))
                        {
                            game.scene.getScene("MainMenu").refreshControls();
                        }
                    }
                });

                this.input.once("pointerdown", (pointer) => 
                {
                    this.input.keyboard.off("keydown");
                    game.scene.getScene("Settings").remapping = false;
                    
                    if(event.keyCode !== Phaser.Input.Keyboard.KeyCodes.ESC)
                    {
                        this.updateBinding(actionName, "MOUSE", pointer.button);
                        game.scene.getScene("Settings").refresh();
                        
                        if(this.scene.isActive(game.scene.getScene("MainMenu")))
                        {
                            game.scene.getScene("MainMenu").refreshControls();
                        }
                    }
                });
            }
            
            updateBinding(actionName, type, value) 
            {
                if(type === "KEY") 
                {
                    this.actions[actionName] = { type: "KEY", code: value };
                } 
                else 
                {
                    this.actions[actionName] = { type: "MOUSE", button: value };
                }
                
                this.refreshControls();

                localStorage.setItem("HCGameControls", JSON.stringify(this.actions));
            }
            
            isActionActive(actionName) 
            {
                const binding = this.actions[actionName];

                if(binding.type === "KEY") 
                {
                    return this.keys[actionName].isDown;
                }

                if(binding.type === "MOUSE") 
                {
                    const pointer = this.input.activePointer;
                    if(binding.button === 0) return pointer.leftButtonDown();
                    if(binding.button === 1) return pointer.middleButtonDown();
                    if(binding.button === 2) return pointer.rightButtonDown();
                }

                return false;
            }

            update(time, delta)
            {
                
            }

            clearAmmoOwned()
            {
                for(const ownedCard of this.ownedCards)
                {
                    if(this.ammoUpgrades.has(ownedCard))
                    {
                        this.ownedCards.delete(ownedCard);
                    }
                }
            }

            returnCardNameFromId(id)
            {
                const card = Object.values(this.upgradeCardData).find(c => c.id === id);
                return card.name;
            }

            updateHighestLevel(newHigh)
            {
                if(newHigh > this.highestLevel)
                {
                    this.highestLevel = newHigh;
                }
            }

            updateCurrentLevel(newCurrent)
            {
                this.currentLevel = newCurrent;
            }

            reset()
            {
                this.highestLevel = 0;
                this.initialHighestLevel = this.highestLevel;
                this.currentLevel = 0;
                this.visitedUpgradeRoom1 = false;
                this.visitedUpgradeRoom2 = false;
                this.visitedUpgradeRoom3 = false;

                this.ownedCards = new Set();

                this.fireModeUpgrade = "buckshot";
                this.damageUpgrade = false;
                this.blockUpgrade = false;
                this.healthUpgrade = false;
                this.doubleFireUpgrade = false;
                this.pistolUpgrade = false;
                this.multiAmmoUpgrade = false;
                this.triplePistolUpgrade = false;
                this.quintuplePistolUpgrade = false;
                this.mousePistolUpgrade = false;
                this.highVelocityUpgrade = false;

                this.level1Data = null;
                this.level2Data = null;
                this.level3Data = null;
                this.level4Data = null;
                
                this.level1BeforePropData = null;
                this.level2BeforePropData = null;
                this.level3BeforePropData = null;
                this.level4BeforePropData = null;
                
                this.level1AfterPropData = null;
                this.level2AfterPropData = null;
                this.level3AfterPropData = null;
                this.level4AfterPropData = null;
            }
            
            switchGameMode(name)
            {
                this.gameMode = name;
                
                this.updateGameMode();
                
                if(checkStorage() === true)
                {
                    localStorage.setItem("HCGameMode", this.gameMode);
                }
            }
            
            changeHUDSetting()
            {
                if(this.HUDSetting === "Score-Only")
                {
                    this.HUDSetting = "Off";
                }
                else if(this.HUDSetting === "Off")
                {
                    this.HUDSetting = "All";
                }
                else if(this.HUDSetting === "All")
                {
                    this.HUDSetting = "Score-Only";
                }
            }
            
            updateGameMode()
            {
                if(this.gameMode === "Standard")
                {
                    this.alwaysBlock = false;
                    this.fireModeConfig = 
                    {
                        "buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "shotgunshot",
                            shellEmitter: "red",
                            pelletCount: 10,
                            spread: 13.5,
                            spreadIncrement: 1.5,
                            pelletVelocity: 400,
                            penetrations: 1,
                            penetrationReduction: 0.75,
                            damage: 1
                        },
                        "slug": 
                        {
                            normalPelletType: "slug",
                            doublePelletType: "slugcult",
                            sound: "slug",
                            shellEmitter: "green",
                            pelletCount: 1,
                            spread: 0,
                            spreadIncrement: 0,
                            pelletVelocity: 550,
                            penetrations: 2,
                            penetrationReduction: 0.5,
                            damage: 10
                        },
                        "birdshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "birdshot",
                            shellEmitter: "blue",
                            pelletCount: 40,
                            spread: 25.35,
                            spreadIncrement: 0.65,
                            pelletVelocity: 500,
                            penetrations: 0,
                            penetrationReduction: 0.33,
                            damage: 0.76
                        },
                        "numfourbuckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "numfourbuckshot",
                            shellEmitter: "black",
                            pelletCount: 20,
                            spread: 19,
                            spreadIncrement: 1,
                            pelletVelocity: 450,
                            penetrations: 0,
                            penetrationReduction: 0.33,
                            damage: 1.2
                        },
                        "000buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "000buckshot",
                            shellEmitter: "red",
                            pelletCount: 8,
                            spread: 5.6,
                            spreadIncrement: 0.8,
                            pelletVelocity: 350,
                            penetrations: 1,
                            penetrationReduction: 0.5,
                            damage: 1.5
                        }
                    };
                }
                else if(this.gameMode === "Easy")
                {
                    this.alwaysBlock = true;
                    this.fireModeConfig = 
                    {
                        "buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "shotgunshot",
                            shellEmitter: "red",
                            pelletCount: 10,
                            spread: 13.5,
                            spreadIncrement: 1.5,
                            pelletVelocity: 400,
                            penetrations: 1,
                            penetrationReduction: 1,
                            damage: 1
                        },
                        "slug": 
                        {
                            normalPelletType: "slug",
                            doublePelletType: "slugcult",
                            sound: "slug",
                            shellEmitter: "green",
                            pelletCount: 1,
                            spread: 0,
                            spreadIncrement: 0,
                            pelletVelocity: 550,
                            penetrations: 2,
                            penetrationReduction: 1,
                            damage: 10
                        },
                        "birdshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "birdshot",
                            shellEmitter: "blue",
                            pelletCount: 40,
                            spread: 25.35,
                            spreadIncrement: 0.65,
                            pelletVelocity: 500,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 0.76
                        },
                        "numfourbuckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "numfourbuckshot",
                            shellEmitter: "black",
                            pelletCount: 20,
                            spread: 19,
                            spreadIncrement: 1,
                            pelletVelocity: 450,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 1.2
                        },
                        "000buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "000buckshot",
                            shellEmitter: "red",
                            pelletCount: 8,
                            spread: 5.6,
                            spreadIncrement: 0.8,
                            pelletVelocity: 350,
                            penetrations: 1,
                            penetrationReduction: 1,
                            damage: 1.5
                        }
                    };
                }
                else if(this.gameMode === "Classic")
                {
                    this.alwaysBlock = false;
                    this.fireModeConfig = 
                    {
                        "buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "shotgunshot",
                            shellEmitter: "red",
                            pelletCount: 10,
                            spread: 13.5,
                            spreadIncrement: 1.5,
                            pelletVelocity: 400,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 1
                        },
                        "slug": 
                        {
                            normalPelletType: "slug",
                            doublePelletType: "slugcult",
                            sound: "slug",
                            shellEmitter: "green",
                            pelletCount: 1,
                            spread: 0,
                            spreadIncrement: 0,
                            pelletVelocity: 550,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 7.5
                        },
                        "birdshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "birdshot",
                            shellEmitter: "blue",
                            pelletCount: 40,
                            spread: 29.25,
                            spreadIncrement: 0.75,
                            pelletVelocity: 500,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 0.5
                        },
                        "numfourbuckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "numfourbuckshot",
                            shellEmitter: "black",
                            pelletCount: 20,
                            spread: 19,
                            spreadIncrement: 1,
                            pelletVelocity: 450,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 1
                        },
                        "000buckshot": 
                        {
                            normalPelletType: "bullet",
                            doublePelletType: "bulletcult",
                            sound: "000buckshot",
                            shellEmitter: "red",
                            pelletCount: 8,
                            spread: 5.6,
                            spreadIncrement: 0.8,
                            pelletVelocity: 350,
                            penetrations: 0,
                            penetrationReduction: 1,
                            damage: 1.5
                        }
                    };
                }
            }
        }
  
        class HUD extends Phaser.Scene
        {
            constructor()
            {
                super({ key: "HUD" });
            }

            create()
            {
                this.gameManager = game.scene.getScene("GameManager");

                this.toggleHUD();
            }
            
            displayGameMode()
            {
                this.gameMode = createText(this, 200, 5, this.gameManager.gameMode, 10, "#ff0000").setOrigin(0.5, 0).setDepth(1232300);
            }
            
            destroyGameMode()
            {
                if(this.gameMode)
                {
                    this.gameMode.destroy();
                    this.gameMode = null;
                }
            }
            
            updateGameMode()
            {
                if(this.gameMode)
                {
                    this.gameMode.setText(this.gameManager.gameMode);
                }
            }
            
            toggleHUD()
            {
                if(this.gameManager.HUDSetting === "All")
                { 
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                    this.displayHighScore();
                    this.displayCurrentScore();
                    this.displayGameMode();
                }
                else if(this.gameManager.HUDSetting === "Score-Only")
                {
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                    this.displayHighScore();
                    this.displayCurrentScore();
                }
                else if(this.gameManager.HUDSetting === "Off")
                {
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                }
            }
            
            refreshHUD()
            {
                if(this.gameManager.HUDSetting === "All")
                { 
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                    this.displayHighScore();
                    this.displayCurrentScore();
                    this.displayGameMode();
                }
                else if(this.gameManager.HUDSetting === "Score-Only")
                {
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                    this.displayHighScore();
                    this.displayCurrentScore();
                }
                else if(this.gameManager.HUDSetting === "Off")
                {
                    this.destroyHighScore();
                    this.destroyCurrentScore();
                    this.destroyGameMode();
                }
            }
            
            displayCurrentScore()
            {
                this.currentScore = createText(this, 5, 5, "Score: " + this.gameManager.score, 10, "#ff0000").setOrigin(0, 0).setDepth(1232300);
                this.updateScore();
            }
            
            destroyCurrentScore()
            {
                if(this.currentScore)
                {
                    this.currentScore.destroy();
                    this.currentScore = null;
                }
            }
            
            displayHighScore()
            {
                this.highScore = createText(this, this.game.config.width - 5, 5, "High Score: " + this.gameManager.highScore, 10, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.updateHighScore();
            }
            
            destroyHighScore()
            {
                if(this.highScore)
                {
                    this.highScore.destroy();
                    this.highScore = null;
                }
            }
            
            updateHighScore()
            {
                if(this.highScore)
                {
                    if(this.gameManager.gameMode === "Classic")
                    {
                        this.highScore.setText("High Score: " + this.gameManager.highScore);
                    }
                    else if(this.gameManager.gameMode === "Standard")
                    {
                        this.highScore.setText("High Score: " + this.gameManager.experimentalHighScore);
                    }
                    else if(this.gameManager.gameMode === "Easy")
                    {
                        this.highScore.setText("High Score: " + this.gameManager.easyHighScore);
                    }
                }
            }
            
            updateScore()
            {
                if(this.currentScore)
                {
                    this.currentScore.setText("Score: " + this.gameManager.score);
                }
            }

            update(time)
            {
                
            }
        }
        
        class Settings extends Phaser.Scene
        {
            constructor()
            {
                super({ key: "Settings" });
                this.remapping = false;
            }
            
            refresh()
            {
                for(let i = 0; i < 2; i++)
                {
                    this.toggleMenu();
                }
            }
            
            toggleMenu()
            {
                if(this.displayedSettings)
                {
                    this.displayedSettings = false;
                    this.destroySettings();
                    
                }
                else
                {
                    this.displayedSettings = true;
                    this.displaySettings();
                    
                }
            }
            
            create()
            {
                this.keyNameLookup = Object.fromEntries(Object.entries(Phaser.Input.Keyboard.KeyCodes).map(([name, code]) => [code, name]));
                this.gameManager = this.scene.get("GameManager");
                this.gameModeWords = this.gameManager.gameMode;
                this.HUD = this.scene.get("HUD");
                
                this.wasd =
                {
                    esc: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)
                };
                
                this.displayedSettings = false;
            }
            
            manualToggleMenu()
            {
                if(this.displayedSettings)
                {
                    this.displayedSettings = false;
                    
                    if(this.gameModeWords !== this.gameManager.gameMode)
                    {
                        this.gameManager.score = 0; 
                        this.gameManager.switchGameMode(this.gameModeWords);

                        if((this.scene.isActive(this.HUD)))
                        {
                            this.HUD.updateScore();
                            this.HUD.updateHighScore();
                            this.HUD.updateGameMode();
                        }
                        
                        if(!this.scene.isActive(game.scene.getScene("MainMenu")))
                        {
                            restartToLevel1(this);
                        }
                    }

                    this.destroySettings();
                }
                else
                {
                    this.displayedSettings = true;
                    this.displaySettings();
                }
            }
            
            update()
            {
                if(Phaser.Input.Keyboard.JustDown(this.wasd.esc))
                {
                    this.manualToggleMenu();
                }
            }
            
            displaySettings()
            {
                this.settings = createText(this, 400 - 5, 5, "Remap Controls:", 20, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                
                this.walkLeft = createText(this, 400 - 5, 10 + this.settings.height, this.getActionAssignment("walkLeft") + ": Walk Left", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.walkLeft.setInteractive({cursor: "pointer"});
                this.walkLeft.on("pointerdown", () =>
                {
                    !this.remapping && this.walkLeft.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("walkLeft");
                });
                
                this.walkRight = createText(this, 400 - 5, 13 + this.settings.height + this.walkLeft.height, this.getActionAssignment("walkRight") + ": Walk Right", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.walkRight.setInteractive({cursor: "pointer"});
                this.walkRight.on("pointerdown", () =>
                {
                    !this.remapping && this.walkRight.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("walkRight");
                });
                
                this.jump = createText(this, 400 - 5, 16 + this.settings.height + this.walkLeft.height + this.walkRight.height, this.getActionAssignment("jump") + ": Jump", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.jump.setInteractive({cursor: "pointer"});
                this.jump.on("pointerdown", () =>
                {
                    !this.remapping && this.jump.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("jump");
                });
                
                this.block =  createText(this, 400 - 5, 19 + this.settings.height + this.walkLeft.height + this.walkRight.height + this.jump.height, this.getActionAssignment("block") + ": Block", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.block.setInteractive({cursor: "pointer"});
                this.block.on("pointerdown", () =>
                {
                    !this.remapping && this.block.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("block");
                });
                
                this.useShotgun = createText(this, 400 - 5, 22 + this.settings.height + this.walkLeft.height + this.walkRight.height + this.jump.height + this.block.height, this.getActionAssignment("useShotgun") + ": Use Shotgun", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.useShotgun.setInteractive({cursor: "pointer"});
                this.useShotgun.on("pointerdown", () =>
                {
                    !this.remapping && this.useShotgun.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("useShotgun");
                });
                
                this.usePistol = createText(this, 400 - 5, 25 + this.settings.height + this.walkLeft.height + this.walkRight.height + this.jump.height + this.block.height + this.useShotgun.height, this.getActionAssignment("usePistol") + ": Use Pistol", 12, "#ff0000").setOrigin(1, 0).setDepth(1232300);
                this.usePistol.setInteractive({cursor: "pointer"});
                this.usePistol.on("pointerdown", () =>
                {
                    !this.remapping && this.usePistol.setColor("#ffffff");
                    !this.remapping && this.gameManager.remapAction("usePistol");
                });
                
                this.resetDefault = createText(this, 400 - 5, 176 - 5, "RESET DEFAULT", 10, "#ff0000").setOrigin(1, 1).setDepth(1232300);
                this.resetDefault.setInteractive({cursor: "pointer"});
                this.resetDefault.on("pointerdown", () =>
                {
                    this.gameManager.resetActions();
                });
                
                this.gameSettings = createText(this, 5, 5, "Settings:", 15, "#ff0000").setOrigin(0, 0).setDepth(1232300);
                
                this.gameMode = createText(this, 5, 10 + this.gameSettings.height, "Game Mode: " + this.gameModeWords, 10, "#ff0000").setOrigin(0, 0).setDepth(1232300);
                this.gameMode.setInteractive({cursor: "pointer"});
                this.gameMode.on("pointerdown", () =>
                {  
                    if(this.gameModeWords === "Standard")
                    {
                        this.gameModeWords = "Easy";
                    }
                    else if(this.gameModeWords === "Easy")
                    {
                        this.gameModeWords = "Classic";
                    }
                    else if(this.gameModeWords === "Classic")
                    {
                        this.gameModeWords = "Standard";
                    }
                    
                    this.gameMode.setText("Game Mode: " + this.gameModeWords);
                    
                    if(this.scene.isActive(game.scene.getScene("MainMenu")))
                    {
                        this.gameManager.switchGameMode(this.gameModeWords);
                    }
                });
                
                this.toggleHUDWords = this.gameManager.HUDSetting;
                    
                this.toggleHUD = createText(this, 5, 13 + this.gameSettings.height + this.gameMode.height, "HUD: " + this.toggleHUDWords, 10, "#ff0000").setOrigin(0, 0).setDepth(1232300);
                this.toggleHUD.setInteractive({cursor: "pointer"});
                this.toggleHUD.on("pointerdown", () =>
                {
                    this.gameManager.changeHUDSetting();

                    if((this.scene.isActive(this.HUD)))
                    {
                        this.HUD.refreshHUD();
                    }

                    this.toggleHUDWords = this.gameManager.HUDSetting;

                    this.toggleHUD.setText("HUD: " + this.toggleHUDWords);
                    
                    if(checkStorage() === true)
                    {
                        localStorage.setItem("HCHUDSetting", this.gameManager.HUDSetting);
                    }
                });
                
                if(this.gameManager.screenShake)
                {
                    this.toggleScreenShakeWords = "On";
                }
                else
                {
                    this.toggleScreenShakeWords = "Off";
                }
                
                this.toggleScreenShake = createText(this, 5, 16 + this.gameSettings.height + this.gameMode.height + this.toggleHUD.height, "Screen Shake: " + this.toggleScreenShakeWords, 10, "#ff0000").setOrigin(0, 0).setDepth(1232300);
                this.toggleScreenShake.setInteractive({cursor: "pointer"});
                this.toggleScreenShake.on("pointerdown", () =>
                {
                    this.gameManager.screenShake = !this.gameManager.screenShake;                   
                    
                    if(this.gameManager.screenShake)
                    {
                        this.toggleScreenShakeWords = "On";
                    }
                    else
                    {
                        this.toggleScreenShakeWords = "Off";
                    }
                    
                    this.toggleScreenShake.setText("Screen Shake: " + this.toggleScreenShakeWords);
                    
                    if(checkStorage() === true)
                    {
                        localStorage.setItem("HCScreenShakeSetting", JSON.stringify(this.gameManager.screenShake));
                    }
                });
                
                this.restartGame = createText(this, 5, 176 - 5, "MAIN MENU", 8, "#ff0000").setOrigin(0, 1).setDepth(1232300);
                this.restartGame.setInteractive({cursor: "pointer"});
                this.restartGame.on("pointerdown", () =>
                {
                    restartToMainMenu(this);
                    if(this.displayedSettings)
                    {
                        this.displayedSettings = false;
                        this.destroySettings();
                    }
                    this.gameManager.resetMappingInProgress();
                    this.gameManager.score = 0; 
                    this.gameManager.switchGameMode(this.gameModeWords);
                });
                
                this.background = this.add.rectangle(200, 0, 400, 176, "#000000").setOrigin(0.5, 0).setAlpha(0.8); 
            }
            
            getActionAssignment(actionName)
            {
                let currentAction = this.gameManager.actions[actionName];
                
                if(currentAction.type === "KEY") 
                {
                    let name = this.keyNameLookup[currentAction.code];
                    
                    try
                    {
                        return name.split("_").map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join("-");
                    }
                    catch(e)
                    {
                        return name;
                    }
                    
                } 
                else 
                {
                    if(currentAction.button === 0)
                    {
                        return "Left-Mouse";
                    }
                    else if(currentAction.button === 1)
                    {
                        return "Middle-Mouse";
                    }
                    else if(currentAction.button === 2)
                    {
                        return "Right-Mouse";
                    }
                    else
                    {
                        return "undefined";
                    }
                }
            }
            
            destroySettings()
            {
                this.settings.destroy();
                this.background.destroy();
                this.walkLeft.destroy();
                this.walkRight.destroy();
                this.jump.destroy();
                this.useShotgun.destroy();
                this.block.destroy();
                this.usePistol.destroy();
                this.resetDefault.destroy();
                this.gameSettings.destroy();
                this.gameMode.destroy();
                this.toggleHUD.destroy();
                this.toggleScreenShake.destroy();
                this.restartGame.destroy();
            }
        }
        
        function checkStorage()
        {
            var test = "test";
    
            try 
            {
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
            return true;
            } 
                catch(e)
            {
                    return false;
            }
        }
        
        document.addEventListener("contextmenu", event => 
        {
            event.preventDefault();
            return false;
        });
  
        const config =
        {
            type: Phaser.AUTO,
            pixelArt: true,
            width: Math.max(400, Math.min(400, (window.innerWidth / window.innerHeight) * 176)),
            height: 176,
    
            scale:
            {
              mode: Phaser.Scale.FIT,
              autoCenter: Phaser.Scale.CENTER_BOTH
            },

            physics:
            {
              default: "arcade",
              arcade:
              {
                gravity: { y: 300 },
                debug: false
              }
            },

            scene:
            [
              Loading,
              MainMenu,
              GameManager,
              UpgradeRoom,
              Level1Game,
              Level2Game,
              Level3Game,
              Level4Game,
              HUD,
              Settings,
              Crosshair
            ]
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>