<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Lawn Purge</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
  <style type="text/css">
    body {
      margin: 0;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background-color: black;
      overflow: hidden;
    }
  </style>
</head>
<body>

<script type="text/javascript">

  var player;
  var ground;
  var playerBulletsHolder;
  var fireRate = 200;
  var lastPlayerShot = 0;
  var aimAngle;
  var cursors;

  class playerBullet extends Phaser.Physics.Arcade.Sprite
  {
    constructor(scene, x, y)
    {
      super(scene, x, y, 'bullet');
      this.speed = 400;
      this.setActive(false);
      this.setVisible(false);
    }

    fire(x, y, angle)
    {
      this.body.reset(x, y);
      this.setActive(true);
      this.setVisible(true);
      this.setRotation(angle);
      this.scene.physics.velocityFromRotation(angle, this.speed, this.body.velocity);
      this.body.allowGravity = false;
    }

    preUpdate(time, delta)
    {
      super.preUpdate(time, delta);

      if (this.y < 0 || this.y > this.scene.sys.game.config.height || this.x < 0 || this.x > this.scene.sys.game.config.width)
      {
        this.setActive(false);
        this.setVisible(false);
      }
    }
  }

  function updateAimAngle(player, pointer)
  {
    if(player.flip === false)
    {
      aimAngle = Phaser.Math.Angle.Between
      (
        player.x + (player.width / 2),
        player.y + (player.height / 16),
        pointer.worldX,
        pointer.worldY
      );
    }
    else
    {
      aimAngle = Phaser.Math.Angle.Between
      (
        player.x - (player.width / 2),
        player.y + (player.height / 16),
        pointer.worldX,
        pointer.worldY
      );
    }
  }

  class MainMenu extends Phaser.Scene
  {
    constructor()
    {
      super({ key: 'MainMenu' });
    }
    preload ()
    {
      this.load.image('sky', 'assets/sky.png');
      this.load.spritesheet('dude', 'assets/guy.png', { frameWidth: 16, frameHeight: 16 });
      this.load.image('ground', 'assets/grass.png');
      this.load.image('bullet', 'assets/bullet.png');
    }

    create ()
    {
      this.physics.world.setBounds(0, 0, 256, 192);

      cursors = this.input.keyboard.createCursorKeys();

      this.sky = this.add.tileSprite(0, 0, 256, this.sys.game.config.height, 'sky').setOrigin(0, 0);
      this.sky.setScrollFactor(0.1);

      this.ground = this.add.tileSprite(
              this.sys.game.config.width / 2,
              this.sys.game.config.height,
              256,
              25,
              'ground'
      );

      this.physics.add.existing(this.ground, true);

      player = this.physics.add.sprite(0, 0, 'dude');
      player.setBounce(0);
      player.setCollideWorldBounds(true);
      player.flip = false;

      this.cameras.main.setBounds(0, 0, 256, 192);
      this.cameras.main.startFollow(player, true, 1, 1, 0, (this.sys.game.config.height / 2));
      this.cameras.main.setZoom(1);

      playerBulletsHolder = this.physics.add.group({
        classType: playerBullet,
        maxSize: 30,
        runChildUpdate: true
      });

      this.physics.add.collider(player, this.ground);

      let logo = this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height / 2, 'Lawn Purge', { fontSize: '16px', fill: '#fff' }).setOrigin(0.5);
    }
    update(time)
    {
      if(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A).isDown || cursors.left.isDown)
      {
        player.setVelocityX(-120);
      }
      else if(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D).isDown || cursors.right.isDown)
      {
        player.setVelocityX(120);
      }
      else
      {
        player.setVelocityX(0);
      }

      if((this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE).isDown || cursors.up.isDown) && player.body.touching.down)
      {
        player.setVelocityY(-200);
      }

      if(this.input.activePointer.worldX < player.getCenter().x)
      {
        player.setFlipX(true);
        player.flip = true;
      }
      else
      {
        player.setFlipX(false);
        player.flip = false;
      }

      updateAimAngle(player, this.input.activePointer);

      if(this.input.activePointer.isDown && time > lastPlayerShot + fireRate)
      {
        let playerBulletsGroup = playerBulletsHolder.get();

        if(playerBulletsGroup)
        {
          if(player.flip === false)
          {
            playerBulletsGroup.fire(player.x + (player.width / 2), player.y + (player.width / 16), aimAngle);
          }
          else
          {
            playerBulletsGroup.fire(player.x - (player.width / 2), player.y + (player.width / 16), aimAngle);
          }
          lastPlayerShot = time;
        }
      }
    }
  }
  class Level1Game extends Phaser.Scene
  {
    constructor()
    {
      super({ key: 'Level1Game' });
    }

    preload()
    {

    }

    create()
    {

    }

    update(time, delta)
    {

    }
  }

  var config =
  {
    type: Phaser.AUTO,
    pixelArt: true,
    width: 256,
    height: 192,

    scale:
    {
      mode: Phaser.Scale.FIT,
      autoCenter: Phaser.Scale.CENTER_BOTH,
    },

    physics:
    {
      default: 'arcade',
      arcade:
      {
        gravity: { y: 300 },
        debug: false
      }
    },

    scene: [
      MainMenu,
      Level1Game
    ]
  };

  var game = new Phaser.Game(config);

</script>
</body>
</html>